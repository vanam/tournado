import{j as e,r as L,u as ae,i as oe,k as se,l as F}from"./react-vendor-B7IL4Whh.js";import{c as le,B,u as V,a as ne,M as Y,D as $}from"./index-jECjWpKM.js";import{u as ce}from"./usePageTitle-CxFjUuTI.js";import{F as x,a as q,S as Q,p as ie}from"./ConfirmModal-CEqukME9.js";import{I as w,C as ue,L as G,g as J,a as Z,d as ee,B as H,i as X,c as me,b as de}from"./BracketRounds-Ce68CqFe.js";import{a as pe,C as xe,G as re,X as ve}from"./icons-kaZEYU8o.js";import"./notifications-B5Q4qzS0.js";import"./radix-ui-BObq5o7x.js";const K=({children:o,className:t})=>e.jsx("p",{className:le("text-sm font-medium text-[var(--color-text)] mb-1",t),children:o});function ge(o,t){function b(s){if(s===0)return;const a=[...o],i=a[s-1],d=a[s];!i||!d||(a[s-1]=d,a[s]=i,t(a.map((h,f)=>({...h,seed:f+1}))))}function c(s){if(s===o.length-1)return;const a=[...o],i=a[s],d=a[s+1];!i||!d||(a[s]=d,a[s+1]=i,t(a.map((h,f)=>({...h,seed:f+1}))))}function y(){const s=[...o];for(let a=s.length-1;a>0;a--){const i=Math.floor(Math.random()*(a+1)),d=s[a],h=s[i];!d||!h||(s[a]=h,s[i]=d)}t(s.map((a,i)=>({...a,seed:i+1})))}function k(){const s=[...o].toSorted((a,i)=>{const d=Number(a.elo),h=Number(i.elo),f=Number.isFinite(d)?d:0,u=Number.isFinite(h)?h:0;return u!==f?u-f:(a.seed??0)-(i.seed??0)});t(s.map((a,i)=>({...a,seed:i+1})))}return{moveUp:b,moveDown:c,shufflePlayers:y,sortPlayersByElo:k}}const he=({index:o,total:t,onMoveUp:b,onMoveDown:c})=>e.jsxs(e.Fragment,{children:[e.jsx(B,{type:"button",variant:"ghost",size:"sm",onClick:()=>{b(o)},disabled:o===0,className:"h-auto px-1.5 py-0.5 text-[var(--color-faint)] hover:text-[var(--color-text)] hover:bg-[var(--color-soft)]",children:e.jsx(pe,{className:"h-3.5 w-3.5"})}),e.jsx(B,{type:"button",variant:"ghost",size:"sm",onClick:()=>{c(o)},disabled:o===t-1,className:"h-auto px-1.5 py-0.5 text-[var(--color-faint)] hover:text-[var(--color-text)] hover:bg-[var(--color-soft)]",children:e.jsx(xe,{className:"h-3.5 w-3.5"})})]}),fe=({useElo:o,onSortByElo:t,onShuffle:b})=>{const{t:c}=V();return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{type:"button",variant:"link",onClick:t,disabled:!o,className:"text-sm px-0 h-auto",children:c("players.sortByElo")}),e.jsx(B,{type:"button",variant:"link",onClick:b,className:"text-sm px-0 h-auto",children:c("players.shuffle")})]})};function be(o,t){return o?"opacity-40 border-[var(--color-border)]":t?"border-[var(--color-primary)] bg-[var(--color-soft)]":"border-[var(--color-border)] hover:border-[var(--color-border-strong)] hover:bg-[var(--color-soft)]"}const ye=({players:o,setPlayers:t,register:b,errors:c,setValue:y,useElo:k,onAddPlayer:s})=>{const{t:a}=V(),{moveUp:i,moveDown:d,shufflePlayers:h,sortPlayersByElo:f}=ge(o,t),[u,N]=L.useState(null),[j,M]=L.useState(null);function D(l){N(l)}function I(l,n){l.preventDefault(),j!==n&&M(n)}function P(l){if(u===null||u===l){N(null),M(null);return}const n=[...o],[m]=n.splice(u,1);if(m===void 0){N(null),M(null);return}n.splice(l,0,m),t(n.map((p,S)=>({...p,seed:S+1}))),N(null),M(null)}function U(){N(null),M(null)}function R(l){const n=o.filter(m=>m.id!==l).map((m,p)=>({...m,seed:p+1}));t(n)}return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(K,{children:a("players.title",{count:o.length})}),o.length>1&&e.jsx(fe,{useElo:k,onSortByElo:f,onShuffle:h})]}),e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_auto] gap-2 sm:flex sm:gap-2",children:[e.jsx(w,{id:"player-name",type:"text","aria-label":a("players.placeholder"),onKeyDown:l=>{l.key==="Enter"&&(l.preventDefault(),s())},placeholder:a("players.placeholder"),className:"min-w-0 sm:flex-1",...b("playerName",{validate:l=>{const n=l.trim();return n?!o.some(m=>m.name.toLowerCase()===n.toLowerCase())||a("players.errorUnique"):!0}})}),e.jsx(B,{type:"button",onClick:()=>{s()},children:a("players.add")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{id:"use-elo",checked:k,onCheckedChange:l=>{y("useElo",l===!0)}}),e.jsx(G,{htmlFor:"use-elo",className:"text-sm text-[var(--color-text)]",children:a("players.useElo")}),e.jsx(w,{id:"elo-rating",type:"number",min:"0","aria-label":a("players.eloPlaceholder"),onKeyDown:l=>{l.key==="Enter"&&(l.preventDefault(),s())},placeholder:a("players.eloPlaceholder"),disabled:!k,className:"w-24",...b("playerElo",{valueAsNumber:!0})})]})]}),c.playerName&&e.jsx("p",{className:"text-[var(--color-accent)] text-sm mb-2",children:c.playerName.message}),e.jsx("ul",{className:"space-y-1",children:o.map((l,n)=>e.jsxs("li",{draggable:!0,onDragStart:()=>{D(n)},onDragOver:m=>{I(m,n)},onDrop:()=>{P(n)},onDragEnd:U,className:`flex items-center gap-2 border rounded-lg px-3 py-2 transition-colors ${be(u===n,j===n)}`,children:[e.jsx(re,{className:"h-4 w-4 text-[var(--color-faint)] cursor-grab shrink-0"}),e.jsxs("span",{className:"text-[var(--color-faint)] text-sm w-6 text-right",children:["#",l.seed]}),e.jsx("span",{className:"flex-1 text-sm",children:l.name}),l.elo!=null&&e.jsx("span",{className:"text-xs text-[var(--color-faint)]",children:a("players.elo",{elo:l.elo})}),e.jsx(he,{index:n,total:o.length,onMoveUp:i,onMoveDown:d}),e.jsx(B,{type:"button",variant:"ghost",size:"sm",onClick:()=>{R(l.id)},className:"h-auto px-1.5 py-0.5 text-[var(--color-accent)] hover:text-[var(--color-primary-dark)] hover:bg-[var(--color-accent-soft)]",children:e.jsx(ve,{className:"h-3.5 w-3.5"})})]},l.id))})]})};function Ne(o,t,b,c,y){return t===b?o.filter(k=>k!==y):t===c?[...o,y]:o}const je=({format:o,players:t,groupCount:b,externalGroups:c,onGroupsChange:y})=>{const{t:k}=V(),s=L.useMemo(()=>o===x.SINGLE_ELIM?J(t):null,[o,t]),a=L.useMemo(()=>o===x.DOUBLE_ELIM?Z(t):null,[o,t]),i=L.useMemo(()=>o===x.GROUPS_TO_BRACKET?ee(t,b):null,[o,t,b]),[d,h]=L.useState(null),[f,u]=L.useState(i),[N,j]=L.useState(null),[M,D]=L.useState(null);f!==i&&(u(i),h(c??i),j(null),D(null));function I(m,p){j({playerId:m,fromGroupIndex:p})}function P(m,p){m.preventDefault(),M!==p&&D(p)}function U(m){m.currentTarget.contains(m.relatedTarget)||D(null)}function R(m){if(!N||!d){j(null),D(null);return}const{playerId:p,fromGroupIndex:S}=N;if(S!==m){const T=d.map((C,A)=>({...C,playerIds:Ne(C.playerIds,A,S,m,p)}));h(T),y?.(T)}j(null),D(null)}function l(){j(null),D(null)}const n=d??i;return!s&&!a&&!n?null:e.jsxs("div",{children:[s&&e.jsx("div",{className:"border border-[var(--color-border)] rounded-xl p-4",children:e.jsx(H,{bracket:s,players:t})}),a&&e.jsx("div",{className:"border border-[var(--color-border)] rounded-xl p-4",children:e.jsx(H,{bracket:a.winners,players:t})}),n&&e.jsx("div",{className:"space-y-3",children:n.map((m,p)=>e.jsxs("div",{onDragOver:S=>{P(S,p)},onDragLeave:U,onDrop:()=>{R(p)},className:`border rounded-xl p-4 transition-colors ${M===p&&N?.fromGroupIndex!==p?"border-[var(--color-primary)] bg-[var(--color-soft)]":"border-[var(--color-border)]"}`,children:[e.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)] mb-3",children:k("groupStage.groupTitle",{label:X(p)})}),e.jsx("ul",{className:"space-y-1 min-h-[2rem]",children:m.playerIds.map((S,T)=>{const C=t.find(r=>r.id===S),A=N?.playerId===S;return e.jsxs("li",{draggable:!0,onDragStart:()=>{I(S,p)},onDragEnd:l,className:`flex items-center gap-2 border border-[var(--color-border)] rounded-lg px-3 py-2 text-sm transition-colors ${A?"opacity-40":""}`,children:[e.jsx(re,{className:"h-4 w-4 text-[var(--color-faint)] cursor-grab shrink-0"}),e.jsxs("span",{className:"text-[var(--color-faint)] w-5 text-right",children:["#",T+1]}),e.jsx("span",{className:"flex-1",children:C?.name??S}),C?.elo!=null&&e.jsx("span",{className:"text-xs text-[var(--color-faint)]",children:k("players.elo",{elo:C.elo})})]},S)})})]},m.id))})]})},Ce=()=>{const o=ae(),{t}=V(),{tracker:b}=ne();ce(t("create.title"));const{register:c,control:y,handleSubmit:k,setValue:s,setError:a,trigger:i,getValues:d,resetField:h,formState:{errors:f}}=oe({defaultValues:{name:"",format:x.SINGLE_ELIM,scoringMode:Q.SETS,maxSets:$,groupStageMaxSets:$,bracketMaxSets:$,groupCount:2,consolation:!1,bracketType:q.SINGLE_ELIM,qualifiers:[{value:2},{value:2}],playerName:"",playerElo:1e3,useElo:!1}}),[u,N]=L.useState([]),{fields:j,append:M,remove:D}=se({control:y,name:"qualifiers"}),I=F({control:y,name:"format"}),P=F({control:y,name:"scoringMode"}),U=F({control:y,name:"bracketType"}),R=F({control:y,name:"useElo"}),l=F({control:y,name:"groupCount"}),[n,m]=L.useState(null),p=n!==null&&n.players===u&&n.format===I&&n.groupCount===l?n.groups:null;async function S(){if(!await i("playerName"))return;const g=d("playerName").trim();if(!g)return;const E=d("playerElo"),v=d("useElo");N([...u,{id:crypto.randomUUID(),name:g,seed:u.length+1,elo:v&&Number.isFinite(E)?E:void 0}]),h("playerName"),h("playerElo")}function T(r){const g=Number.parseInt(r,10);return Number.isFinite(g)?Math.max(1,g):$}function C(r){const g=Math.max(1,Number.parseInt(r,10)||1);if(s("groupCount",g),g>j.length){const E=g-j.length;for(let v=0;v<E;v++)M({value:2})}else if(g<j.length){const E=Array.from({length:j.length-g},(v,_)=>g+_);D(E)}}const A=k(r=>{if(u.length<Y){a("root",{message:t("create.errorPlayers",{minPlayers:Y})});return}if(r.format===x.GROUPS_TO_BRACKET&&r.groupCount>u.length){a("root",{message:t("create.errorGroupsTooMany")});return}const g=r.qualifiers.map(O=>O.value);if(r.format===x.GROUPS_TO_BRACKET){const O=p??ee(u,r.groupCount);for(const[W,te]of O.entries()){const z=g[W]??0;if(z>0&&te.playerIds.length<z){a("root",{message:t("create.errorGroupTooFewPlayers",{label:X(W),count:z})});return}}}const E={id:crypto.randomUUID(),name:r.name.trim(),scoringMode:r.scoringMode,maxSets:r.maxSets,groupStageMaxSets:r.groupStageMaxSets,bracketMaxSets:r.bracketMaxSets,players:u.map(O=>({...O})),createdAt:new Date().toISOString(),completedAt:null,winnerId:null};let v;switch(r.format){case x.SINGLE_ELIM:{v={...E,format:x.SINGLE_ELIM,bracket:J(u)};break}case x.ROUND_ROBIN:{v={...E,format:x.ROUND_ROBIN,schedule:de(u)};break}case x.DOUBLE_ELIM:{v={...E,format:x.DOUBLE_ELIM,doubleElim:Z(u)};break}case x.GROUPS_TO_BRACKET:{const O=me(u,{groupCount:r.groupCount,qualifiers:g,consolation:r.consolation,bracketType:r.bracketType},p??void 0);v={...E,format:x.GROUPS_TO_BRACKET,groupStage:O,groupStagePlayoffs:null};break}default:throw new Error(`Unsupported format: ${String(r.format)}`)}const _={[x.SINGLE_ELIM]:q.SINGLE_ELIM,[x.DOUBLE_ELIM]:q.DOUBLE_ELIM,[x.GROUPS_TO_BRACKET]:r.bracketType,[x.ROUND_ROBIN]:"none"};b.trackTournamentCreated({tournament_type:r.format,scoring_mode:r.scoringMode,player_count:u.length,playoff_type:_[r.format]??"none"}),ie.save(v),o(`/tournament/${v.id}`)});return e.jsxs("div",{className:"max-w-lg mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold text-[var(--color-text)] mb-8",children:t("create.title")}),e.jsxs("form",{onSubmit:r=>{A(r)},className:"space-y-7",children:[e.jsxs("div",{children:[e.jsx(G,{htmlFor:"tournament-name",className:"block text-sm font-medium text-[var(--color-text)] mb-1",children:t("create.nameLabel")}),e.jsx(w,{id:"tournament-name",type:"text",placeholder:t("create.namePlaceholder"),...c("name",{required:t("create.errorName")})}),f.name&&e.jsx("p",{className:"text-[var(--color-accent)] text-sm mt-1",children:f.name.message})]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.formatLabel")}),e.jsx("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:gap-3",children:Object.values(x).map(r=>e.jsxs("label",{className:`flex items-center justify-center flex-1 text-center px-4 py-2 rounded-lg border text-sm cursor-pointer transition-colors ${I===r?"bg-[var(--color-primary)] text-[var(--color-surface)] border-[var(--color-primary)] shadow-sm":"text-[var(--color-muted)] border-[var(--color-border)] hover:border-[var(--color-primary)]"}`,children:[e.jsx("input",{type:"radio",value:r,className:"sr-only",...c("format")}),t(`format.${r}`)]},r))})]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.scoringLabel")}),e.jsx("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:gap-3",children:Object.values(Q).map(r=>e.jsxs("label",{className:`flex-1 text-center px-4 py-2 rounded-lg border text-sm cursor-pointer transition-colors ${P===r?"bg-[var(--color-primary)] text-[var(--color-surface)] border-[var(--color-primary)] shadow-sm":"text-[var(--color-muted)] border-[var(--color-border)] hover:border-[var(--color-primary)]"}`,children:[e.jsx("input",{type:"radio",value:r,className:"sr-only",...c("scoringMode")}),t(r===Q.SETS?"create.scoringSets":"create.scoringPoints")]},r))})]}),I!==x.GROUPS_TO_BRACKET&&e.jsxs("div",{children:[e.jsx(G,{htmlFor:"max-sets",className:"block text-sm font-medium text-[var(--color-text)] mb-1",children:t("create.maxSetsLabel")}),e.jsx(w,{id:"max-sets",type:"number",min:"1",className:"w-24",...c("maxSets",{valueAsNumber:!0,onChange:r=>{s("maxSets",T(r.target.value))}})})]}),I===x.GROUPS_TO_BRACKET&&e.jsxs("div",{className:"space-y-4 border border-[var(--color-border)] rounded-xl p-5 bg-[var(--color-soft)]",children:[e.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:t("create.groupStageTitle")}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(G,{className:"text-xs text-[var(--color-muted)]",children:[t("create.maxSetsGroupLabel"),e.jsx(w,{id:"group-stage-max-sets",type:"number",min:"1",className:"mt-1 w-24 h-8 px-2 py-1",...c("groupStageMaxSets",{valueAsNumber:!0,onChange:r=>{s("groupStageMaxSets",T(r.target.value))}})})]}),e.jsxs(G,{className:"text-xs text-[var(--color-muted)]",children:[t("create.maxSetsBracketLabel"),e.jsx(w,{id:"bracket-max-sets",type:"number",min:"1",className:"mt-1 w-24 h-8 px-2 py-1",...c("bracketMaxSets",{valueAsNumber:!0,onChange:r=>{s("bracketMaxSets",T(r.target.value))}})})]})]}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"group-count",className:"block text-sm font-medium text-[var(--color-text)] mb-1",children:t("create.groupCountLabel")}),e.jsx(w,{id:"group-count",type:"number",min:"1",className:"w-24",...c("groupCount",{valueAsNumber:!0,onChange:r=>{C(r.target.value)}})})]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.qualifiersLabel")}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:j.map((r,g)=>e.jsxs(G,{className:"text-xs text-[var(--color-muted)]",children:[t("create.groupLabel",{label:X(g)}),e.jsx(w,{type:"number",min:"0",className:"mt-1 w-full h-8 px-2 py-1",...c(`qualifiers.${g}.value`,{valueAsNumber:!0})})]},r.id))})]}),e.jsxs(G,{className:"flex items-center gap-2 text-sm text-[var(--color-text)]",children:[e.jsx("input",{id:"consolation",type:"checkbox",...c("consolation")}),t("create.consolationLabel")]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.bracketTypeLabel")}),e.jsx("div",{className:"grid grid-cols-2 gap-2 sm:flex sm:gap-3",children:Object.values(q).map(r=>e.jsxs("label",{className:`flex-1 text-center px-4 py-2 rounded-lg border text-sm cursor-pointer transition-colors ${U===r?"bg-[var(--color-primary)] text-[var(--color-surface)] border-[var(--color-primary)] shadow-sm":"text-[var(--color-muted)] border-[var(--color-border)] hover:border-[var(--color-primary)]"}`,children:[e.jsx("input",{type:"radio",value:r,className:"sr-only",...c("bracketType")}),t(r===q.SINGLE_ELIM?"create.bracketTypeSingle":"create.bracketTypeDouble")]},r))})]})]}),e.jsx(ye,{players:u,setPlayers:N,register:c,errors:f,setValue:s,useElo:R,onAddPlayer:()=>{S()}}),e.jsx(je,{format:I,players:u,groupCount:l,externalGroups:p,onGroupsChange:r=>{const E=r.flatMap(v=>v.playerIds).map(v=>u.find(_=>_.id===v)).filter(v=>v!==void 0).map((v,_)=>({...v,seed:_+1}));N(E),m({groups:r,players:E,format:I,groupCount:l})}}),f.root&&e.jsx("p",{className:"text-[var(--color-accent)] text-sm",children:f.root.message}),e.jsx(B,{type:"submit",className:"w-full bg-[var(--color-primary)] text-[var(--color-surface)] py-3 rounded-lg font-medium shadow-sm hover:shadow-md hover:bg-[var(--color-primary-dark)] active:scale-[0.99]",children:t("create.submit")})]})]})};export{Ce as CreateTournamentPage};

import{r as g,j as t,b as Le,m as nt,L as re,h as rt}from"./react-vendor-DmXkgcPG.js";import{F as D,S as B,a as be}from"./ConfirmModal-Vvv4-snp.js";import{u as N,D as H,B as Q,a as st}from"./index-BRLIsEJ6.js";import{u as at}from"./usePageTitle-DUGhzTy5.js";import{p as ne}from"./persistence-D9kAeSho.js";import{d as se,e as de,B as z,M as J,f as Fe,S as X,h as We,i as Oe,j as Ae,k as Ge,l as je,m as ye,n as ot,o as ve,p as it,q as lt}from"./BracketRounds-DE0E6v_t.js";import{c as $e,d as Se,b as ct,X as dt,e as ut,f as mt}from"./icons-CuKFc0l-.js";import{T as ft,a as xt,b as ke,c as Ne,d as pt,e as Ie,f as K,R as he,S as _e,g as He,h as ht}from"./SwissStandingsTable-Cf96IxUD.js";import{a as ae,b as q,e as Ue,f as qe,i as oe,h as ue,j as gt,k as ze,l as bt,m as we}from"./groupStageUtils-CjXJR-r_.js";import"./radix-ui-BYwnsWBt.js";import"./notifications-DgSurA1O.js";const Je=g.createContext(null);function ie(){const e=g.useContext(Je);if(!e)throw new Error("useTournament must be used within TournamentProvider");return e}function le(e){const{tournament:n,updateTournament:r,isLoading:s}=ie(),a=n?.format===e?n:null,c=g.useCallback(l=>{r(i=>i.format!==e?i:l(i))},[r,e]);return{tournament:a,updateTournament:c,isLoading:s}}function jt(){const{tournament:e,updateTournament:n,isLoading:r}=ie(),s=e?.format===D.GROUPS_TO_BRACKET?e:null,a=g.useCallback(c=>{n(l=>l.format!==D.GROUPS_TO_BRACKET?l:typeof c=="function"?c(l):c)},[n]);return{tournament:s,updateTournament:a,isLoading:r}}const yt=({tournamentId:e,children:n})=>{const r=g.useSyncExternalStore(ne.subscribe,g.useCallback(()=>ne.load(e),[e])),s=g.useCallback(c=>{const l=ne.load(e);l&&ne.save(c(l))},[e]),a=g.useMemo(()=>({tournament:r,updateTournament:s,isLoading:!1}),[r,s]);return t.jsx(Je.Provider,{value:a,children:n})},Z=({label:e})=>e?t.jsx("div",{className:"mb-6 bg-[var(--color-accent-soft)] border border-[var(--color-accent-border)] rounded-xl p-5 shadow-sm text-center",children:t.jsxs("p",{className:"text-xl font-bold text-[var(--color-accent)] tracking-wide",children:[t.jsx($e,{className:"h-6 w-6 inline-block mr-2 text-[var(--color-accent)]"}),e]})}):null;function vt(e,n){return e==null?"?":e===n||n==null?`${e}.`:`${e}.-${n}.`}function St(e){return e===1?"bg-[var(--color-podium-gold)] font-semibold":e===2?"bg-[var(--color-podium-silver)]":e===3?"bg-[var(--color-podium-bronze)]":""}const ee=({results:e})=>{const{t:n}=N();return!e||e.length===0?null:t.jsxs(ft,{children:[t.jsx(xt,{children:t.jsxs(ke,{className:"border-b-2 border-[var(--color-border)]",children:[t.jsx(Ne,{className:"py-2.5 pr-3 text-xs uppercase tracking-wider font-semibold text-[var(--color-muted)]",children:n("results.rank")}),t.jsx(Ne,{className:"py-2.5 pr-3 text-xs uppercase tracking-wider font-semibold text-[var(--color-muted)]",children:n("results.player")})]})}),t.jsx(pt,{children:e.map(r=>t.jsxs(ke,{className:St(r.rankStart),children:[t.jsxs(Ie,{className:"py-2.5 pr-3 text-[var(--color-faint)] tabular-nums",children:[r.rankStart===1&&t.jsx($e,{className:"h-4 w-4 inline-block mr-1 text-yellow-500"}),r.rankStart===2&&t.jsx(Se,{className:"h-4 w-4 inline-block mr-1 text-gray-400"}),r.rankStart===3&&t.jsx(Se,{className:"h-4 w-4 inline-block mr-1 text-amber-600"}),vt(r.rankStart,r.rankEnd)]}),t.jsx(Ie,{className:"py-2.5 pr-3 font-medium",children:r.name})]},r.playerId))})]})};function Ee(e,n){const r=(e.setsWon??0)-(e.setsLost??0),s=[e.points??0,r,e.setsWon??0];if(n===B.POINTS){const a=(e.pointsWon??0)-(e.pointsLost??0);s.push(a)}return s.join("|")}function kt(e,n={}){const r=n.scoringMode??B.SETS,s=[];let a=0;for(;a<e.length;){const c=e[a];if(!c)break;const l=Ee(c,r);let i=a+1;for(;i<e.length;){const d=e[i];if(!d||Ee(d,r)!==l)break;i+=1}const u=a+1,o=i;for(let d=a;d<i;d+=1){const f=e[d];f&&s.push({...f,rankStart:u,rankEnd:o})}a=i}return s}function Nt(e,n,r={}){const s=de(e,n,r);return kt(s,r)}function It(e){const n=new Set;if(!e)return n;for(const r of e.rounds)for(const s of r)s.player1Id&&n.add(s.player1Id),s.player2Id&&n.add(s.player2Id);return n}function Ke(e,n){const r=new Map;let s=n;for(const a of e){if(a.length===0)continue;const c=s-a.length+1,l=s;for(const i of a)r.set(i,{rankStart:c,rankEnd:l});s=c-1}return{rankByPlayer:r}}function ge(e){return[...e].toSorted((n,r)=>{const s=n.rankStart??Number.POSITIVE_INFINITY,a=r.rankStart??Number.POSITIVE_INFINITY;if(s!==a)return s-a;const c=n.rankEnd??Number.POSITIVE_INFINITY,l=r.rankEnd??Number.POSITIVE_INFINITY;return c!==l?c-l:n.name.localeCompare(r.name)})}function Me(e,n){return n?e.map(r=>r.rankStart==null||r.rankEnd==null?r:{...r,rankStart:r.rankStart+n,rankEnd:r.rankEnd+n}):e}function me(e,n){if(!e)return[];const r=new Map(n.map(o=>[o.id,o])),s=[...It(e)],a=[],c=new Set;for(const[o,d]of e.rounds.entries()){const f=[];for(const m of d){if(!m.winnerId||!m.player1Id||!m.player2Id)continue;const p=m.winnerId===m.player1Id?m.player2Id:m.player1Id;c.has(p)||(c.add(p),f.push(p))}a[o]=f}const{rankByPlayer:l}=Ke(a,s.length),i=se(e);if(i&&l.set(i,{rankStart:1,rankEnd:1}),e.thirdPlaceMatch?.winnerId){const o=e.thirdPlaceMatch,d=o.winnerId===o.player1Id?o.player2Id:o.player1Id;o.winnerId&&l.set(o.winnerId,{rankStart:3,rankEnd:3}),d&&l.set(d,{rankStart:4,rankEnd:4})}const u=s.map(o=>{const d=r.get(o);return{playerId:o,name:d?.name??o,...l.get(o)}});return ge(u)}function wt(e){const n=new Set;if(!e)return n;for(const s of e.winners.rounds)for(const a of s)a.player1Id&&n.add(a.player1Id),a.player2Id&&n.add(a.player2Id);for(const s of e.losers.rounds)for(const a of s)a.player1Id&&n.add(a.player1Id),a.player2Id&&n.add(a.player2Id);const r=e.finals;return r.grandFinal.player1Id&&n.add(r.grandFinal.player1Id),r.grandFinal.player2Id&&n.add(r.grandFinal.player2Id),r.resetFinal.player1Id&&n.add(r.resetFinal.player1Id),r.resetFinal.player2Id&&n.add(r.resetFinal.player2Id),n}function fe(e,n){if(!e)return[];const r=new Map(n.map(x=>[x.id,x])),s=[...wt(e)],a=new Map(s.map(x=>[x,0])),c=new Set,l=e.losers.rounds,i=Array.from({length:l.length+2},()=>[]),u=x=>{if(!x?.winnerId||!x.player1Id||!x.player2Id)return;const b=x.winnerId===x.player1Id?x.player2Id:x.player1Id;a.set(b,(a.get(b)??0)+1)},o=(x,b)=>{if(!x?.winnerId||!x.player1Id||!x.player2Id)return;const h=x.winnerId===x.player1Id?x.player2Id:x.player1Id;if(c.has(h))return;const I=(a.get(h)??0)+1;if(a.set(h,I),I>=2){const S=i[b];S&&S.push(h),c.add(h)}};for(const x of e.winners.rounds)for(const b of x)u(b);for(const[x,b]of l.entries())for(const h of b)o(h,x);const d=l.length;o(e.finals.grandFinal,d),o(e.finals.resetFinal,d+1);const{rankByPlayer:f}=Ke(i,s.length),m=ae(e);m&&f.set(m,{rankStart:1,rankEnd:1});const p=s.map(x=>{const b=r.get(x);return{playerId:x,name:b?.name??x,...f.get(x)}});return ge(p)}const Et=()=>{const{tournament:e,updateTournament:n}=le(D.SINGLE_ELIM),[r,s]=g.useState(null),[a,c]=g.useState("playoff"),{t:l}=N();if(!e)return null;const{bracket:i,players:u}=e,o=e.scoringMode??B.SETS,d=e.maxSets??H,f=se(i),m=i.thirdPlaceMatch,p=[{id:"playoff",label:l("tabs.playoff")},{id:"results",label:l("tabs.results")}];function x(b,h,I,S=!1){n(y=>{const v=h?We(structuredClone(y.bracket),b,h,I,S):Oe(structuredClone(y.bracket),b),L=se(v);return{...y,bracket:v,winnerId:L,completedAt:L?new Date().toISOString():null}}),s(null)}return t.jsxs("div",{children:[f&&t.jsx(Z,{label:l("bracket.winner",{name:u.find(b=>b.id===f)?.name??""})}),t.jsx(K,{tabs:p,activeId:a,onChange:c}),a==="playoff"?t.jsxs(t.Fragment,{children:[t.jsx(z,{bracket:i,players:u,scoringMode:o,maxSets:d,showSeedNumbers:!0,onEditMatch:b=>{s(b)}}),m&&(m.player1Id??m.player2Id)&&t.jsxs("div",{className:"mt-6",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)] mb-2",children:l("bracket.thirdPlace")}),t.jsx(J,{match:m,players:u,canEdit:Fe(i,m.id),onClick:()=>{s(m)},scoringMode:o,maxSets:d,roundIndex:i.rounds.length})]}),r&&t.jsx(X,{match:r,players:u,scoringMode:o,maxSets:d,onSave:x,onClose:()=>{s(null)}})]}):t.jsx(ee,{results:me(i,u)})]})};function Ce(e){return e?e.player1Id||e.player2Id||e.winnerId?!0:Array.isArray(e.scores)&&e.scores.length>0:!1}const Mt=()=>{const{tournament:e,updateTournament:n}=le(D.DOUBLE_ELIM),{t:r}=N(),[s,a]=g.useState(null),[c,l]=g.useState("playoff"),i=e?.doubleElim,u=g.useMemo(()=>e?.players??[],[e?.players]),o=e?.scoringMode??B.SETS,d=e?.maxSets??H,f=[{id:"playoff",label:r("tabs.playoff")},{id:"results",label:r("tabs.results")}],m=g.useMemo(()=>i?ae(i):null,[i]),p=g.useMemo(()=>m?u.find(y=>y.id===m):null,[u,m]),x=i?.winners.rounds.length??0;function b(y,v,L,R=!1){i&&(n(M=>{const C=v?Ue(structuredClone(M.doubleElim),y,v,L,R):qe(structuredClone(M.doubleElim),y),P=ae(C);return{...M,doubleElim:C,winnerId:P,completedAt:P?new Date().toISOString():null}}),a(null))}if(!e||!i)return null;const h=i.finals,I=Ce(h.grandFinal),S=Ce(h.resetFinal);return t.jsxs("div",{className:"space-y-8",children:[p&&t.jsx(Z,{label:r("bracket.winner",{name:u.find(y=>y.id===p.id)?.name??""})}),t.jsx(K,{tabs:f,activeId:c,onChange:l}),c==="playoff"?t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:r("doubleElim.winnersBracket")}),t.jsx(z,{bracket:i.winners,players:u,scoringMode:o,maxSets:d,showSeedNumbers:!0,onEditMatch:y=>{a(y)},canEditMatchFn:(y,v)=>q(i,v)})]}),i.losers.rounds.length>0&&t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:r("doubleElim.losersBracket")}),t.jsx(z,{bracket:i.losers,players:u,scoringMode:o,maxSets:d,showSeedNumbers:!0,onEditMatch:y=>{a(y)},canEditMatchFn:(y,v)=>q(i,v)})]}),(I||S)&&t.jsxs("div",{className:"space-y-4",children:[t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:r("doubleElim.grandFinal")}),I&&t.jsx(J,{match:h.grandFinal,players:u,canEdit:q(i,h.grandFinal.id),scoringMode:o,maxSets:d,showSeedNumbers:!0,roundIndex:x,onClick:()=>{a(h.grandFinal)}}),S&&t.jsxs("div",{children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)] mb-2",children:r("doubleElim.resetFinal")}),t.jsx(J,{match:h.resetFinal,players:u,canEdit:q(i,h.resetFinal.id),scoringMode:o,maxSets:d,showSeedNumbers:!0,roundIndex:x,onClick:()=>{a(h.resetFinal)}})]})]}),s&&t.jsx(X,{match:s,players:u,scoringMode:o,maxSets:d,onSave:b,onClose:()=>{a(null)}})]}):t.jsx(ee,{results:fe(i,u)})]})};function Ct(e){const n=new Map;for(const r of e.rounds)for(const s of r.matches){if(s.dummy)continue;const a=[s.player1Id,s.player2Id].toSorted((c,l)=>c===null&&l===null?0:c===null?1:l===null?-1:c.localeCompare(l)).join("|");n.set(a,s)}return n}function Tt(e,n,r){const s=[n,r].toSorted((a,c)=>a.localeCompare(c)).join("|");return e.get(s)}function Rt(e,n,r,s){if(!n)return{text:"",bold:!1};if(n.scores.length===0&&!n.walkover)return{text:"",bold:!1};const a=n.walkover||Ae(n.scores),c=n.player1Id!==e.id,{p1Sets:l,p2Sets:i}=Ge(n.scores,{scoringMode:r,maxSets:s}),u=c?`${i}-${l}`:`${l}-${i}`;let o;return n.winnerId?o=n.winnerId===e.id:c?o=i>l:o=l>i,{text:a?`${u} WO`:u,bold:o}}function Pt(e,n,r,s){const a=n.find(m=>m.id===e.player1Id),c=n.find(m=>m.id===e.player2Id),l=a?.name??"?",i=c?.name??"?";if(e.scores.length===0&&!e.walkover)return`${l} – ${i}`;const u=e.walkover||Ae(e.scores),{p1Sets:o,p2Sets:d}=Ge(e.scores,{scoringMode:r,maxSets:s}),f=u?`${o}-${d} WO`:`${o}-${d}`;return`${l} – ${i}: ${f}`}const V={border:"1px solid #555",padding:"2px 4px",fontSize:"10px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",textAlign:"center",verticalAlign:"middle"},Ve=({groupLabel:e,players:n,schedule:r,scoringMode:s,maxSets:a})=>{const{t:c}=N(),l=g.useMemo(()=>Ct(r),[r]),i=`${(100/(n.length+1)).toFixed(3)}%`,u=Math.min(Math.max(r.rounds.length,1),4);return t.jsxs("div",{style:{fontFamily:"Arial, Helvetica, sans-serif",color:"#000",backgroundColor:"#fff",height:"190mm",overflow:"hidden",display:"flex",flexDirection:"column",gap:"2mm",boxSizing:"border-box"},children:[t.jsx("div",{style:{flexShrink:0,fontWeight:"bold",fontSize:"13px"},children:e}),t.jsx("div",{style:{flexShrink:0},children:t.jsxs("table",{style:{width:"100%",tableLayout:"fixed",borderCollapse:"collapse"},children:[t.jsx("colgroup",{children:Array.from({length:n.length+1}).map((o,d)=>t.jsx("col",{style:{width:i}},d))}),t.jsx("thead",{children:t.jsxs("tr",{children:[t.jsx("th",{style:{...V,textAlign:"left",backgroundColor:"#f0f0f0"}}),n.map(o=>t.jsx("th",{style:{...V,fontWeight:"bold",backgroundColor:"#f0f0f0"},children:o.name},o.id))]})}),t.jsx("tbody",{children:n.map(o=>t.jsxs("tr",{children:[t.jsx("th",{style:{...V,textAlign:"left",fontWeight:"bold",backgroundColor:"#f0f0f0"},children:o.name}),n.map(d=>{if(o.id===d.id)return t.jsx("td",{style:{...V,backgroundColor:"#d8d8d8"},children:"×"},d.id);const f=Tt(l,o.id,d.id),{text:m,bold:p}=Rt(o,f,s,a);return t.jsx("td",{style:{...V,fontWeight:p?"bold":"normal"},children:m},d.id)})]},o.id))})]})}),t.jsx("hr",{style:{flexShrink:0,border:"none",borderTop:"1px solid #999",margin:"0"}}),t.jsxs("div",{style:{flex:"1 1 auto",overflow:"hidden"},children:[t.jsx("div",{style:{fontWeight:"bold",fontSize:"10px",marginBottom:"1mm"},children:c("roundRobin.schedule")}),t.jsx("div",{style:{columnCount:u,columnGap:"5mm",fontSize:"9px",lineHeight:"1.5"},children:r.rounds.map(o=>{const d=o.byePlayerId?n.find(m=>m.id===o.byePlayerId):null,f=o.matches.filter(m=>!m.dummy&&m.player1Id!=null&&m.player2Id!=null);return t.jsxs("div",{style:{breakInside:"avoid",marginBottom:"1.5mm"},children:[t.jsxs("div",{style:{fontWeight:"bold",marginBottom:"0.5mm"},children:[c("roundRobin.round",{n:o.roundNumber}),d!=null&&t.jsxs("span",{style:{fontWeight:"normal"},children:[" ",c("roundRobin.bye",{name:d.name})]})]}),f.map(m=>t.jsx("div",{style:{paddingLeft:"3mm"},children:Pt(m,n,s,a)},m.id))]},o.roundNumber)})})]})]})},Dt=()=>{const{tournament:e,updateTournament:n}=le(D.ROUND_ROBIN),[r,s]=g.useState("standings"),[a,c]=g.useState(null),[l,i]=g.useState(null),{t:u}=N();g.useEffect(()=>{if(l===null)return;const S=()=>{i(null)};return window.addEventListener("afterprint",S,{once:!0}),window.print(),()=>{window.removeEventListener("afterprint",S)}},[l]);const o=g.useCallback(()=>{e&&i({groupLabel:e.name,players:e.players,schedule:e.schedule,scoringMode:e.scoringMode??B.SETS,maxSets:e.maxSets??H})},[e]);if(!e)return null;const{schedule:d,players:f}=e,m=e.scoringMode??B.SETS,p=e.maxSets??H,x=de(d,f,{scoringMode:m,maxSets:p}),b=je(d),h=[{id:"standings",label:u("roundRobin.standings")},{id:"matrix",label:u("roundRobin.matrix")},{id:"schedule",label:u("roundRobin.schedule")},{id:"results",label:u("roundRobin.results")}];function I(S,y,v,L=!1){n(R=>{const M=structuredClone(R.schedule);for(const G of M.rounds){const O=G.matches.find(U=>U.id===S);if(O){O.winnerId=y,O.scores=v,O.walkover=L;break}}const C=je(M),P=C?de(M,R.players,{scoringMode:m,maxSets:p}):null;return{...R,schedule:M,winnerId:C?P?.[0]?.playerId??null:null,completedAt:C?new Date().toISOString():null}}),c(null)}return t.jsxs("div",{children:[b&&t.jsx(Z,{label:u("roundRobin.winner",{name:x[0]?.name??""})}),t.jsx(K,{tabs:h,activeId:r,onChange:s}),r==="schedule"?t.jsx(he,{schedule:d,players:f,onEditMatch:c,scoringMode:m,maxSets:p}):t.jsxs(t.Fragment,{children:[r==="standings"&&t.jsx(_e,{standings:x,scoringMode:m}),r==="matrix"&&t.jsxs("div",{className:"mt-6",children:[t.jsx("div",{className:"flex justify-end mb-2",children:t.jsx("button",{onClick:o,title:u("roundRobin.print"),className:"p-1 rounded text-[var(--color-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-soft)] transition-colors","aria-label":u("roundRobin.print"),children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"15",height:"15",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:[t.jsx("polyline",{points:"6 9 6 2 18 2 18 9"}),t.jsx("path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"}),t.jsx("rect",{x:"6",y:"14",width:"12",height:"8"})]})})}),t.jsx(He,{schedule:d,players:f,scoringMode:m,maxSets:p})]}),r!=="standings"&&r!=="matrix"&&t.jsx("div",{className:"mt-6",children:t.jsx(ee,{results:Nt(d,f,{scoringMode:m})})})]}),a&&t.jsx(X,{match:a,players:f,scoringMode:m,maxSets:p,onSave:I,onClose:()=>{c(null)}}),(()=>{const S=document.querySelector("#print-root");return l!==null&&S!==null?Le.createPortal(t.jsx(Ve,{...l}),S):null})()]})},Bt=()=>{const{tournament:e,updateTournament:n}=ie(),{t:r}=N(),[s,a]=g.useState(null),[c,l]=g.useState(""),[i,u]=g.useState("");if(!e)return t.jsx("div",{className:"mb-6"});const{players:o}=e;function d(p){a(p.id),l(p.name),u("")}function f(){a(null),l(""),u("")}function m(p){const x=c.trim();if(!x){u(r("tournament.nameEmpty"));return}if(o.some(b=>b.id!==p&&b.name.toLowerCase()===x.toLowerCase())){u(r("tournament.nameDuplicate"));return}n(b=>({...b,players:b.players.map(h=>h.id===p?{...h,name:x}:h)})),a(null),l(""),u("")}return t.jsxs("div",{className:"mb-6",children:[t.jsxs("h3",{className:"text-sm font-semibold text-[var(--color-muted)] mb-2",children:[r("tournament.playersList")," (",o.length,")"]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:o.map(p=>t.jsx("div",{children:s===p.id?t.jsxs("div",{className:"flex items-center gap-1",children:[t.jsx("input",{type:"text",id:`edit-player-${p.id}`,"aria-label":r("tournament.editName"),value:c,onChange:x=>{l(x.target.value),u("")},onKeyDown:x=>{x.key==="Enter"&&m(p.id),x.key==="Escape"&&f()},className:`border rounded px-2 py-1 text-sm w-32 focus:outline-none focus:ring-2 focus:ring-[var(--color-primary)] bg-[var(--color-card)] ${i?"border-[var(--color-accent-border)]":"border-[var(--color-border)]"}`}),t.jsx("button",{onClick:()=>{m(p.id)},className:"text-[var(--color-primary)] hover:text-[var(--color-primary-dark)] text-sm px-1",title:r("tournament.saveName"),children:t.jsx(ct,{className:"h-3.5 w-3.5"})}),t.jsx("button",{onClick:f,className:"text-[var(--color-faint)] hover:text-[var(--color-muted)] text-sm px-1",title:r("tournament.cancelEdit"),children:t.jsx(dt,{className:"h-3.5 w-3.5"})})]}):t.jsxs("button",{type:"button",onClick:()=>{d(p)},className:"inline-flex items-center gap-2 bg-[var(--color-soft)] border border-[var(--color-border)] rounded-full px-3 py-1 text-sm text-[var(--color-text)] cursor-pointer hover:bg-[var(--color-soft)] hover:border-[var(--color-primary)] transition-colors",title:r("tournament.editName"),"aria-label":r("tournament.editName"),children:[t.jsx("span",{className:"truncate",children:p.name}),p.elo!=null&&t.jsx("span",{className:"text-xs font-normal text-[var(--color-muted)]",children:r("players.elo",{elo:p.elo})})]})},p.id))}),i&&t.jsx("p",{className:"text-[var(--color-accent)] text-xs mt-1",children:i})]})},Ye=({player:e,groupLabel:n,tagType:r})=>{const{t:s}=N(),a={qualifier:"bg-[var(--color-soft)] text-[var(--color-primary-dark)]",lucky:"bg-[var(--color-accent-soft)] text-[var(--color-accent)]"},c={qualifier:s("groupStage.advancerQualifierTag"),lucky:s("groupStage.advancerLuckyTag")};return t.jsxs("li",{className:"flex items-start justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("div",{className:"text-sm font-medium text-[var(--color-text)]",children:e.name}),t.jsx("div",{className:"text-xs text-[var(--color-muted)]",children:s("groupStage.advancerGroupRank",{group:n,rank:e.groupRank})})]}),t.jsx("span",{className:`text-xs font-semibold px-2 py-1 rounded-full ${a[r]}`,children:c[r]})]})},Lt=({qualifiers:e,groupLabelById:n})=>{const{t:r}=N();return t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)] uppercase tracking-wide",children:r("groupStage.qualifiersTitle")}),t.jsx("ul",{className:"space-y-2",children:e.map(s=>t.jsx(Ye,{player:s,groupLabel:n.get(s.groupId)??s.groupId,tagType:"qualifier"},s.id))})]})},Ft=({luckyLosers:e,hasLucky:n,groupLabelById:r})=>{const{t:s}=N();return t.jsxs("div",{className:"space-y-3",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)] uppercase tracking-wide",children:s("groupStage.luckyLosersTitle")}),n?t.jsx("ul",{className:"space-y-2",children:e.map(a=>t.jsx(Ye,{player:a,groupLabel:r.get(a.groupId)??a.groupId,tagType:"lucky"},a.id))}):t.jsx("div",{className:"text-xs text-[var(--color-muted)]",children:s("groupStage.luckyLosersNone")})]})};function Wt(e){return Number.isFinite(e)?`${(e*100).toFixed(1)}%`:"0%"}function xe(e){return Number.isFinite(e)?e.toFixed(2):"0.00"}function Te(e){const n=xe(e);return e>0?`+${n}`:n}function Ot(e,n,r){const s=e.tiebreakDetails,a=Array.isArray(e.tiebreakApplied)?e.tiebreakApplied.filter(i=>i==="setsWonPerMatch"||i==="setDiffPerMatch"||i==="pointsDiffPerMatch"||i==="opponentAvgRank"||i==="relativeRank"||i==="fairPlay"||i==="lottery"):[],c={setsWonPerMatch:n("groupStage.luckyCriteriaSetsWon"),setDiffPerMatch:n("groupStage.luckyCriteriaSetDiff"),pointsDiffPerMatch:n("groupStage.luckyCriteriaPointsDiff"),opponentAvgRank:n("groupStage.luckyCriteriaOpponentRank"),relativeRank:n("groupStage.luckyCriteriaRelativeRank"),fairPlay:n("groupStage.luckyCriteriaFairPlay"),lottery:n("groupStage.luckyCriteriaLottery")},l={setsWonPerMatch:n("groupStage.luckyCriteriaSetsWonHelp"),setDiffPerMatch:n("groupStage.luckyCriteriaSetDiffHelp"),pointsDiffPerMatch:n("groupStage.luckyCriteriaPointsDiffHelp"),opponentAvgRank:n("groupStage.luckyCriteriaOpponentRankHelp"),relativeRank:n("groupStage.luckyCriteriaRelativeRankHelp"),fairPlay:n("groupStage.luckyCriteriaFairPlayHelp"),lottery:n("groupStage.luckyCriteriaLotteryHelp")};return a.filter(i=>r||i!=="pointsDiffPerMatch").map(i=>{let u="-";return i==="setsWonPerMatch"&&(u=xe(s.setsWonPerMatch)),i==="setDiffPerMatch"&&(u=Te(s.setDiffPerMatch)),i==="pointsDiffPerMatch"&&(u=Te(s.pointsDiffPerMatch)),i==="opponentAvgRank"&&(u=xe(s.opponentAvgRank)),i==="relativeRank"&&(u=Wt(s.relativeRank)),i==="fairPlay"&&(u=s.fairPlay?n("groupStage.luckyCriteriaYes"):n("groupStage.luckyCriteriaNo")),i==="lottery"&&(u=n("groupStage.luckyCriteriaApplied")),{key:i,label:c[i],value:u,help:l[i]}})}const At=({player:e,showBalls:n})=>{const{t:r}=N(),s=Ot(e,r,n);return s.length===0?null:t.jsx("table",{className:"w-full text-[0.7rem] text-[var(--color-muted)]",children:t.jsx("tbody",{children:s.map(a=>t.jsxs("tr",{className:"border-t border-[var(--color-border-soft)]",children:[t.jsx("td",{className:"py-1 pr-2 font-medium",children:t.jsx("span",{className:"underline decoration-dotted underline-offset-2 cursor-help",title:a.help,children:a.label})}),t.jsx("td",{className:"py-1 text-right",children:a.value})]},a.key))})})},Gt=({player:e,index:n,groupLabel:r,isLucky:s,showBalls:a,isExpanded:c,onToggle:l})=>{const{t:i}=N(),u=e.stats,o=s?"bg-[var(--color-accent-soft)]":"",d=a?9:8;return t.jsxs(g.Fragment,{children:[t.jsxs("tr",{className:`border-b border-[var(--color-border-soft)] ${o} cursor-pointer`,onClick:l,onKeyDown:f=>{(f.key==="Enter"||f.key===" ")&&(f.preventDefault(),l())},role:"button",tabIndex:0,"aria-expanded":c,children:[t.jsxs("td",{className:"py-2 pr-2 text-[var(--color-faint)]",children:[t.jsx("span",{className:"mr-1 inline-flex h-3 w-3 items-center justify-center text-[var(--color-muted)]","aria-hidden":"true",children:t.jsx("svg",{viewBox:"0 0 20 20",className:`h-3 w-3 transition-transform ${c?"rotate-90":"rotate-0"}`,fill:"currentColor",children:t.jsx("path",{d:"M7.5 5.5 12.5 10 7.5 14.5"})})}),n+1]}),t.jsx("td",{className:"py-2 pr-2 font-medium text-[var(--color-text)]",children:e.name}),t.jsx("td",{className:"py-2 pr-2 text-[var(--color-muted)]",children:i("groupStage.advancerGroupRank",{group:r,rank:e.groupRank})}),t.jsx("td",{className:"py-2 pr-2 text-center",children:u.played??0}),t.jsx("td",{className:"py-2 pr-2 text-center",children:u.wins??0}),t.jsx("td",{className:"py-2 pr-2 text-center",children:u.losses??0}),t.jsxs("td",{className:"py-2 pr-2 text-center",children:[u.setsWon??0,"-",u.setsLost??0]}),a&&t.jsxs("td",{className:"py-2 pr-2 text-center",children:[u.pointsWon??0,"-",u.pointsLost??0]}),t.jsx("td",{className:"py-2 text-center font-semibold",children:u.points??0})]}),c&&t.jsx("tr",{className:`border-b border-[var(--color-border-soft)] ${o}`,children:t.jsx("td",{className:"px-2",colSpan:d,children:t.jsx(At,{player:e,showBalls:a})})})]})},$t=({candidates:e,luckyIdSet:n,groupLabelById:r,showBalls:s,expandedId:a,onToggleExpand:c})=>{const{t:l}=N();return t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)] uppercase tracking-wide",children:l("groupStage.luckyCandidatesTitle")}),t.jsx("div",{className:"overflow-x-auto",children:t.jsxs("table",{className:"w-full text-xs",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"border-b border-[var(--color-border-soft)] text-left text-[var(--color-muted)]",children:[t.jsx("th",{className:"py-2 pr-2",children:l("standings.rank")}),t.jsx("th",{className:"py-2 pr-2",children:l("standings.player")}),t.jsx("th",{className:"py-2 pr-2",children:l("standings.group")}),t.jsx("th",{className:"py-2 pr-2 text-center",children:l("standings.played")}),t.jsx("th",{className:"py-2 pr-2 text-center",children:l("standings.wins")}),t.jsx("th",{className:"py-2 pr-2 text-center",children:l("standings.losses")}),t.jsx("th",{className:"py-2 pr-2 text-center",children:l("standings.sets")}),s&&t.jsx("th",{className:"py-2 pr-2 text-center",children:l("standings.balls")}),t.jsx("th",{className:"py-2 text-center",children:l("standings.points")})]})}),t.jsx("tbody",{children:e.map((i,u)=>t.jsx(Gt,{player:i,index:u,groupLabel:r.get(i.groupId)??i.groupId,isLucky:n.has(i.id),showBalls:s,isExpanded:a===i.id,onToggle:()=>{c(i.id)}},i.id))})]})})]})},_t=({qualifiers:e,luckyLosers:n,luckyCandidates:r=[],groups:s,bracketTargetSize:a,scoringMode:c=B.SETS})=>{const{t:l}=N(),[i,u]=g.useState(null),o=g.useMemo(()=>{const b=new Map;for(const[h,I]of s.entries())b.set(I.id,l("groupStage.groupTitle",{label:oe(h)}));return b},[s,l]),d=g.useMemo(()=>new Set(n.map(b=>b.id)),[n]),f=c===B.POINTS,m=n.length>0,p=r.length>0;if(e.length===0&&!m)return null;const x=b=>{u(h=>h===b?null:b)};return t.jsxs("div",{className:"border border-[var(--color-border)] rounded-xl p-4 space-y-4 bg-[var(--color-card)]",children:[t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:l("groupStage.advancersTitle")}),m&&t.jsx("div",{className:"text-xs text-[var(--color-muted)]",children:l("groupStage.luckyLoserNote",{target:a})}),t.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[t.jsx(Lt,{qualifiers:e,groupLabelById:o}),t.jsxs("div",{className:"space-y-4",children:[t.jsx(Ft,{luckyLosers:n,hasLucky:m,groupLabelById:o}),m&&p&&t.jsx($t,{candidates:r,luckyIdSet:d,groupLabelById:o,showBalls:f,expandedId:i,onToggleExpand:x})]})]})]})},Ht=({group:e,groupIndex:n,groupPlayers:r,standings:s,qualifierCount:a,wildCardIds:c,activeTab:l,onTabChange:i,onEditMatch:u,onPrint:o,scoringMode:d,maxSets:f})=>{const{t:m}=N(),p=[{id:"standings",label:m("roundRobin.standings")},{id:"results",label:m("roundRobin.matrix")},{id:"schedule",label:m("roundRobin.schedule")}];return t.jsxs("div",{className:"border border-[var(--color-border)] rounded-xl p-4 bg-[var(--color-card)]",children:[t.jsx("div",{className:"mb-4",children:t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:m("groupStage.groupTitle",{label:oe(n)})})}),t.jsx(K,{tabs:p,activeId:l,onChange:i}),l==="schedule"&&t.jsx(he,{schedule:e.schedule,players:r,onEditMatch:u,scoringMode:d,maxSets:f}),l==="standings"&&t.jsx(_e,{standings:s,highlightCount:a,wildCardIds:c,scoringMode:d}),l==="results"&&t.jsxs("div",{className:"mt-6",children:[t.jsx("div",{className:"flex justify-end mb-2",children:t.jsx("button",{onClick:o,title:m("groupStage.printGroup"),className:"p-1 rounded text-[var(--color-muted)] hover:text-[var(--color-text)] hover:bg-[var(--color-soft)] transition-colors","aria-label":m("groupStage.printGroup"),children:t.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"15",height:"15",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round","aria-hidden":"true",children:[t.jsx("polyline",{points:"6 9 6 2 18 2 18 9"}),t.jsx("path",{d:"M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"}),t.jsx("rect",{x:"6",y:"14",width:"12",height:"8"})]})})}),t.jsx(He,{schedule:e.schedule,players:r,scoringMode:d,maxSets:f})]})]})},Ut=({groupStage:e,players:n,standingsByGroup:r,wildCardIds:s,groupTabs:a,onGroupTabChange:c,onEditMatch:l,scoringMode:i,maxSets:u})=>{const{t:o}=N(),[d,f]=g.useState(null);g.useEffect(()=>{if(d===null)return;const x=()=>{f(null)};return window.addEventListener("afterprint",x,{once:!0}),window.print(),()=>{window.removeEventListener("afterprint",x)}},[d]);const m=g.useCallback((x,b)=>{const h=e.groups.find(y=>y.id===x);if(!h)return;const I=ue(h,n),S=o("groupStage.groupTitle",{label:oe(b)});f({groupLabel:S,players:I,schedule:h.schedule,scoringMode:i,maxSets:u})},[e.groups,n,i,u,o]),p=document.querySelector("#print-root");return t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"space-y-6",children:e.groups.map((x,b)=>{const h=ue(x,n),I=r.find(v=>v.groupId===x.id)?.standings,S=e.settings.qualifiers[b]??0,y=a[x.id]??"standings";return t.jsx(Ht,{group:x,groupIndex:b,groupPlayers:h,standings:I??[],qualifierCount:S,wildCardIds:s,activeTab:y,onTabChange:v=>{c(x.id,v)},onEditMatch:v=>{l(x.id,v.id)},onPrint:()=>{m(x.id,b)},scoringMode:i,maxSets:u},x.id)})}),d!==null&&p!==null?Le.createPortal(t.jsx(Ve,{...d}),p):null]})},Re=({title:e,bracket:n,players:r,onEditMatch:s,wildCardIds:a,scoringMode:c,maxSets:l,groupPlacementByPlayerId:i})=>{const{t:u}=N();if(!n)return null;const o=n.thirdPlaceMatch??null,d=n.rounds.length;return t.jsxs("div",{className:"border border-[var(--color-border)] rounded-xl p-4 space-y-4",children:[t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:e}),t.jsx(z,{bracket:n,players:r,wildCardIds:a,scoringMode:c,maxSets:l,groupPlacementByPlayerId:i,onEditMatch:s}),o&&(o.player1Id??o.player2Id)&&t.jsxs("div",{className:"mt-2",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)] mb-2",children:u("bracket.thirdPlace")}),t.jsx(J,{match:o,players:r,wildCardIds:a,canEdit:Fe(n,o.id),onClick:()=>{s(o)},scoringMode:c,maxSets:l,roundIndex:d})]})]})},Pe=({title:e,doubleElim:n,players:r,onEditMatch:s,wildCardIds:a,scoringMode:c,maxSets:l,groupPlacementByPlayerId:i})=>{const{t:u}=N();return n?t.jsxs("div",{className:"border border-[var(--color-border)] rounded-xl p-4 space-y-4",children:[t.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:e}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)]",children:u("doubleElim.winnersBracket")}),t.jsx(z,{bracket:n.winners,players:r,wildCardIds:a,scoringMode:c,maxSets:l,groupPlacementByPlayerId:i,onEditMatch:o=>{s(o.id)}})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)]",children:u("doubleElim.losersBracket")}),t.jsx(z,{bracket:n.losers,players:r,wildCardIds:a,scoringMode:c,maxSets:l,groupPlacementByPlayerId:i,onEditMatch:o=>{s(o.id)}})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx("div",{className:"text-xs font-semibold text-[var(--color-muted)]",children:u("doubleElim.finals")}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[t.jsx(J,{match:n.finals.grandFinal,players:r,wildCardIds:a,canEdit:q(n,n.finals.grandFinal.id),onClick:()=>{s(n.finals.grandFinal.id)},scoringMode:c,maxSets:l,roundIndex:n.winners.rounds.length}),n.finals.resetFinal.player1Id&&n.finals.resetFinal.player2Id&&t.jsx(J,{match:n.finals.resetFinal,players:r,wildCardIds:a,canEdit:q(n,n.finals.resetFinal.id),onClick:()=>{s(n.finals.resetFinal.id)},scoringMode:c,maxSets:l,roundIndex:n.winners.rounds.length+1})]})]})]}):null},qt=({playoffs:e,isDoubleElim:n,players:r,wildCardIds:s,groupPlacementByPlayerId:a,scoringMode:c,maxSets:l,onEditMainBracketMatch:i,onEditConsolationBracketMatch:u,onEditMainDoubleElimMatch:o,onEditConsolationDoubleElimMatch:d})=>{const{t:f}=N();if(!e)return null;const m=!n&&e.mainBracket,p=n&&e.mainDoubleElim,x=!n&&e.consolationBracket,b=n&&e.consolationDoubleElim;return!m&&!p?null:t.jsxs(t.Fragment,{children:[m&&t.jsx(Re,{title:f("groupStage.mainBracket"),bracket:e.mainBracket,players:r,wildCardIds:s,scoringMode:c,maxSets:l,groupPlacementByPlayerId:a,onEditMatch:i}),p&&t.jsx(Pe,{title:f("groupStage.mainBracket"),doubleElim:e.mainDoubleElim,players:r,wildCardIds:s,scoringMode:c,maxSets:l,groupPlacementByPlayerId:a,onEditMatch:o}),x&&t.jsx(Re,{title:f("groupStage.consolationBracket"),bracket:e.consolationBracket,players:r,wildCardIds:s,scoringMode:c,maxSets:l,groupPlacementByPlayerId:a,onEditMatch:u}),b&&t.jsx(Pe,{title:f("groupStage.consolationBracket"),doubleElim:e.consolationDoubleElim,players:r,wildCardIds:s,scoringMode:c,maxSets:l,groupPlacementByPlayerId:a,onEditMatch:d})]})},zt=({editing:e,activeMatch:n,activePlayers:r,scoringMode:s,groupStageMaxSets:a,bracketMaxSets:c,onSave:l,onClose:i})=>{if(!n||!e)return null;const u=e.type==="group"?a:c;return t.jsx(X,{match:n,players:r,scoringMode:s,maxSets:u,onSave:l,onClose:i})};function Jt(e,n,r){const s=e.groups.find(a=>a.id===n);if(!s)return null;for(const a of s.schedule.rounds){const c=a.matches.find(l=>l.id===r);if(c)return c}return null}function Kt(e,n){if(!e)return null;if(e.thirdPlaceMatch?.id===n)return e.thirdPlaceMatch;for(const r of e.rounds){const s=r.find(a=>a.id===n);if(s)return s}return null}function Vt(e,n){if(!e)return null;for(const r of e.winners.rounds){const s=r.find(a=>a.id===n);if(s)return s}for(const r of e.losers.rounds){const s=r.find(a=>a.id===n);if(s)return s}return e.finals.grandFinal.id===n?e.finals.grandFinal:e.finals.resetFinal.id===n?e.finals.resetFinal:null}function Yt(e,n,r,s){return g.useMemo(()=>e?gt(e,n,{scoringMode:r,maxSets:s}):[],[e,n,r,s])}function Qt(e){return g.useMemo(()=>e?ze(e):!1,[e])}function Xt(e,n,r,s,a){return g.useMemo(()=>!e||!n?null:bt(n,r,{scoringMode:s,maxSets:a}),[e,n,r,s,a])}function Zt(e){return g.useMemo(()=>e?new Set(e.luckyLosers.map(n=>n.id)):null,[e])}function en(e,n){return g.useMemo(()=>{if(!e||!n)return null;const r=new Map(n.groups.map((c,l)=>[c.id,oe(l)])),s=new Map,a=c=>{const l=r.get(c.groupId);!l||!c.groupRank||s.set(c.id,`${l}${c.groupRank}`)};for(const c of e.main)a(c);for(const c of e.luckyLosers)a(c);for(const c of e.consolation)a(c);return s},[e,n])}function pe(e){return e?e.rounds.some(n=>n.some(r=>r.scores.length>0||r.winnerId)):!1}function De(e){return e?!!(pe(e.winners)||e.losers.rounds.some(n=>n.some(r=>r.scores.length>0||r.winnerId))||e.finals.grandFinal.winnerId||e.finals.resetFinal.winnerId):!1}function tn(e,n){return e===n?!0:!e||!n?!1:e.bracketType===n.bracketType&&JSON.stringify(e.mainBracket)===JSON.stringify(n.mainBracket)&&JSON.stringify(e.mainDoubleElim)===JSON.stringify(n.mainDoubleElim)&&JSON.stringify(e.consolationBracket)===JSON.stringify(n.consolationBracket)&&JSON.stringify(e.consolationDoubleElim)===JSON.stringify(n.consolationDoubleElim)}function nn(e){const n=e.groupStagePlayoffs??e.groupStageBrackets;return n||null}function Y(e,n){return e?n&&e.mainDoubleElim?ae(e.mainDoubleElim):e.mainBracket?se(e.mainBracket):null:null}function Be(e,n){return e?n?!!e.mainDoubleElim||!!e.consolationDoubleElim:!!e.mainBracket||!!e.consolationBracket:!1}function rn(e,n){return e?n?De(e.mainDoubleElim)||De(e.consolationDoubleElim):pe(e.mainBracket)||pe(e.consolationBracket):!1}const sn=()=>{const{tournament:e,updateTournament:n}=jt(),{t:r}=N(),[s,a]=g.useState(null),[c,l]=g.useState({}),[i,u]=g.useState("tournament"),o=e?.groupStage,d=g.useMemo(()=>e?.players??[],[e?.players]),f=e?nn(e):null,m=e?.scoringMode??B.SETS,p=e?.groupStageMaxSets??e?.maxSets??H,x=e?.bracketMaxSets??e?.maxSets??H,h=(f?.bracketType??o?.settings.bracketType??be.SINGLE_ELIM)===be.DOUBLE_ELIM,I=Yt(o,d,m,p),S=Qt(o),y=Xt(S,o,d,m,p),v=Zt(y),L=en(y,o),R=g.useMemo(()=>e?e.winnerId?e.winnerId:Y(f,h):null,[f,e,h]),M=g.useMemo(()=>R?d.find(j=>j.id===R):null,[d,R]);g.useEffect(()=>{if(!S||!y||!o||Be(f,h)&&rn(f,h))return;const w=we(o,d,{scoringMode:m,maxSets:p});if(tn(f,w))return;const E=Y(w,h);n(F=>({...F,groupStagePlayoffs:w,winnerId:E??null,completedAt:E?new Date().toISOString():null}))},[y,S,o,f,d,m,p,n,h,e]);const C=g.useMemo(()=>{if(!s||!o)return null;if(s.type==="group"&&s.groupId)return Jt(o,s.groupId,s.matchId);if(s.type==="mainBracket"||s.type==="consolationBracket"){const j=f?.[s.type];return Kt(j,s.matchId)}if(s.type==="mainDoubleElim"||s.type==="consolationDoubleElim"){const j=f?.[s.type];return Vt(j,s.matchId)}return null},[s,o,f]),P=g.useMemo(()=>{if(!s||!o)return d;if(s.type==="group"){const j=o.groups.find(k=>k.id===s.groupId);return j?ue(j,d):d}return d},[s,o,d]),G=g.useMemo(()=>{if(i!=="results")return[];let j=[],k=[];return f&&(h&&f.mainDoubleElim?j=fe(f.mainDoubleElim,d):f.mainBracket&&(j=me(f.mainBracket,d)),h&&f.consolationDoubleElim?k=Me(fe(f.consolationDoubleElim,d),j.length):f.consolationBracket&&(k=Me(me(f.consolationBracket,d),j.length))),ge([...j,...k])},[i,f,d,h]);function O(j,k,w,E=!1){if(!o)return;const F=structuredClone(o);for(const _ of F.groups)for(const et of _.schedule.rounds){const te=et.matches.find(tt=>tt.id===j);if(te){te.winnerId=k,te.scores=w,te.walkover=E;break}}let T=f;const W=f&&Be(f,h);ze(F)&&!W&&(T=we(F,d,{scoringMode:m,maxSets:p}));const A=Y(T,h);n(_=>({..._,groupStage:F,groupStagePlayoffs:T,winnerId:A??null,completedAt:A?new Date().toISOString():null})),a(null)}function U(j,k,w,E,F=!1){if(!f||!o)return;const T=structuredClone(f),W=T[E];if(!W)return;T[E]=k?We(W,j,k,w,F):Oe(W,j);const A=Y(T,h);n(_=>({..._,groupStage:o,groupStagePlayoffs:T,winnerId:A??null,completedAt:A?new Date().toISOString():null})),a(null)}function $(j,k,w,E,F=!1){if(!f||!o)return;const T=structuredClone(f),W=T[E];if(!W)return;T[E]=k?Ue(W,j,k,w,F):qe(W,j);const A=Y(T,h);n(_=>({..._,groupStage:o,groupStagePlayoffs:T,winnerId:A??null,completedAt:A?new Date().toISOString():null})),a(null)}function ce(j,k,w,E){if(s)switch(s.type){case"group":{O(j,k,w,E);break}case"mainBracket":{U(j,k,w,"mainBracket",E);break}case"consolationBracket":{U(j,k,w,"consolationBracket",E);break}case"mainDoubleElim":{$(j,k,w,"mainDoubleElim",E);break}case"consolationDoubleElim":{$(j,k,w,"consolationDoubleElim",E);break}}}function Qe(j,k){l(w=>({...w,[j]:k}))}function Xe(j,k){a({type:"group",groupId:j,matchId:k})}const Ze=[{id:"tournament",label:r("tabs.tournament")},{id:"results",label:r("tabs.results")}];return!e||!o?null:t.jsxs("div",{className:"space-y-8",children:[M&&t.jsx(Z,{label:r("bracket.winner",{name:M.name})}),t.jsx(K,{tabs:Ze,activeId:i,onChange:u}),i==="results"?t.jsx(ee,{results:G}):t.jsxs(t.Fragment,{children:[t.jsx(Ut,{groupStage:o,players:d,standingsByGroup:I,wildCardIds:v,groupTabs:c,onGroupTabChange:Qe,onEditMatch:Xe,scoringMode:m,maxSets:p}),y&&t.jsx(_t,{qualifiers:y.main,luckyLosers:y.luckyLosers,luckyCandidates:y.luckyCandidates,groups:o.groups,bracketTargetSize:y.bracketTargetSize,scoringMode:m}),t.jsx(qt,{playoffs:f,isDoubleElim:h,players:d,wildCardIds:v,groupPlacementByPlayerId:L,scoringMode:m,maxSets:x,onEditMainBracketMatch:j=>{a({type:"mainBracket",matchId:j.id})},onEditConsolationBracketMatch:j=>{a({type:"consolationBracket",matchId:j.id})},onEditMainDoubleElimMatch:j=>{a({type:"mainDoubleElim",matchId:j})},onEditConsolationDoubleElimMatch:j=>{a({type:"consolationDoubleElim",matchId:j})}}),t.jsx(zt,{editing:s,activeMatch:C,activePlayers:P,scoringMode:m,groupStageMaxSets:p,bracketMaxSets:x,onSave:ce,onClose:()=>{a(null)}})]})]})},an=()=>{const{tournament:e,updateTournament:n}=le(D.SWISS),[r,s]=g.useState("standings"),[a,c]=g.useState(null),{t:l}=N();if(!e)return null;const{schedule:i,players:u}=e,o=e.scoringMode??B.SETS,d=e.maxSets??H,f=o===B.POINTS,m=ye(i,u,{scoringMode:o,maxSets:d}),p=ot(i),x=ve(e),b=i.rounds.length,h=e.totalRounds,I=[{id:"standings",label:l("swiss.standings")},{id:"schedule",label:l("swiss.schedule")},...x?[{id:"results",label:l("swiss.results")}]:[]];function S(v,L,R,M=!1){n(C=>{const P=structuredClone(C.schedule);for(const U of P.rounds){const $=U.matches.find(ce=>ce.id===v);if($){$.winnerId=L,$.scores=R,$.walkover=M;break}}const G=ve({...C,schedule:P}),O=G?ye(P,C.players,{scoringMode:o,maxSets:d}):null;return{...C,schedule:P,winnerId:G?O?.[0]?.playerId??null:null,completedAt:G?new Date().toISOString():null}}),c(null)}function y(){n(v=>({...v,schedule:{rounds:[...v.schedule.rounds,lt(v)]}}))}return t.jsxs("div",{children:[x&&t.jsx(Z,{label:l("swiss.winner",{name:m[0]?.name??""})}),t.jsx(K,{tabs:I,activeId:r,onChange:s}),r==="standings"&&t.jsx(ht,{standings:m,showPoints:f}),r==="schedule"&&t.jsxs("div",{children:[t.jsx(he,{schedule:i,players:u,onEditMatch:c,scoringMode:o,maxSets:d,roundLabelKey:"swiss.round",byeLabelKey:"swiss.bye"}),t.jsx("div",{className:"mt-4 text-sm text-[var(--color-muted)]",children:l("swiss.roundProgress",{current:b,total:h})}),p&&!x&&t.jsx("div",{className:"mt-4",children:t.jsx(Q,{onClick:y,children:l("swiss.generateNextRound",{n:b+1})})})]}),r==="results"&&x&&t.jsx("div",{className:"mt-6",children:t.jsx(ee,{results:it(m)})}),a&&t.jsx(X,{match:a,players:u,scoringMode:o,maxSets:d,onSave:S,onClose:()=>{c(null)}})]})},on=()=>{const{tournament:e,isLoading:n}=ie(),{t:r}=N(),s=rt(),{tracker:a}=st();return g.useEffect(()=>{a.trackPageView({})},[s,a]),at(e?e.name:r("tournament.notFoundTitle")),n?t.jsx("div",{className:"text-center py-12",children:t.jsx("p",{className:"text-[var(--color-muted)]",children:r("tournament.loading")})}):e?t.jsxs("div",{children:[t.jsxs("div",{className:"mb-6",children:[t.jsx("h1",{className:"text-2xl font-bold text-[var(--color-text)]",children:e.name}),t.jsxs("p",{className:"text-sm text-[var(--color-muted)]",children:[r(`format.${e.format}`)," ·"," ",r("tournament.players",{count:e.players.length})]})]}),t.jsx(Bt,{}),e.format===D.SINGLE_ELIM&&t.jsx(Et,{}),e.format===D.ROUND_ROBIN&&t.jsx(Dt,{}),e.format===D.DOUBLE_ELIM&&t.jsx(Mt,{}),e.format===D.GROUPS_TO_BRACKET&&t.jsx(sn,{}),e.format===D.SWISS&&t.jsx(an,{})]}):t.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[50vh] text-center px-4",children:[t.jsx(mt,{className:"h-12 w-12 text-[var(--color-muted)] mb-4"}),t.jsx("h2",{className:"text-xl font-semibold text-[var(--color-text)] mb-2",children:r("tournament.notFoundTitle")}),t.jsx("p",{className:"text-[var(--color-muted)] mb-6 max-w-md",children:r("tournament.notFoundDesc")}),t.jsxs("div",{className:"flex gap-3 flex-wrap justify-center",children:[t.jsx(Q,{asChild:!0,children:t.jsx(re,{to:"/create",children:r("home.newTournament")})}),t.jsx(Q,{variant:"primary-outlined",asChild:!0,children:t.jsx(re,{to:"/",children:r("tournament.backHome")})})]})]})},jn=()=>{const{id:e}=nt(),{t:n}=N();return e?t.jsx(yt,{tournamentId:e,children:t.jsx(on,{})}):t.jsxs("div",{className:"flex flex-col items-center justify-center min-h-[50vh] text-center px-4",children:[t.jsx(ut,{className:"h-12 w-12 text-[var(--color-muted)] mb-4"}),t.jsx("h2",{className:"text-xl font-semibold text-[var(--color-text)] mb-2",children:n("tournament.notFoundTitle")}),t.jsx("p",{className:"text-[var(--color-muted)] mb-6 max-w-md",children:n("tournament.noIdDesc")}),t.jsxs("div",{className:"flex gap-3 flex-wrap justify-center",children:[t.jsx(Q,{asChild:!0,children:t.jsx(re,{to:"/create",children:n("home.newTournament")})}),t.jsx(Q,{variant:"primary-outlined",asChild:!0,children:t.jsx(re,{to:"/",children:n("tournament.backHome")})})]})]})};export{jn as TournamentPage};

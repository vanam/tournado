import{j as e,r as I,u as ae,i as oe,k as se,l as F}from"./react-vendor-DmXkgcPG.js";import{c as le,B,u as V,a as ne,M as Y,D as $}from"./index-DAqj-68i.js";import{u as ce}from"./usePageTitle-BHQ_PxoD.js";import{p as ie}from"./persistence-DbUWYKXp.js";import{I as _,C as ue,L as G,g as J,B as H,c as me,a as de,b as pe}from"./BracketRounds-Ce6ZctY8.js";import{g as Z,d as ee,i as Q,c as xe}from"./groupStageUtils-RCsEkkxh.js";import{a as ge,C as ve,G as re,X as he}from"./icons-CuKFc0l-.js";import{F as d,a as q,S as W}from"./ConfirmModal-CfzEFSX8.js";import"./notifications-DgSurA1O.js";import"./radix-ui-BYwnsWBt.js";const K=({children:o,className:t})=>e.jsx("p",{className:le("text-sm font-medium text-[var(--color-text)] mb-1",t),children:o});function fe(o,t){function b(s){if(s===0)return;const a=[...o],u=a[s-1],p=a[s];!u||!p||(a[s-1]=p,a[s]=u,t(a.map((h,f)=>({...h,seed:f+1}))))}function i(s){if(s===o.length-1)return;const a=[...o],u=a[s],p=a[s+1];!u||!p||(a[s]=p,a[s+1]=u,t(a.map((h,f)=>({...h,seed:f+1}))))}function y(){const s=[...o];for(let a=s.length-1;a>0;a--){const u=Math.floor(Math.random()*(a+1)),p=s[a],h=s[u];!p||!h||(s[a]=h,s[u]=p)}t(s.map((a,u)=>({...a,seed:u+1})))}function k(){const s=[...o].toSorted((a,u)=>{const p=Number(a.elo),h=Number(u.elo),f=Number.isFinite(p)?p:0,c=Number.isFinite(h)?h:0;return c!==f?c-f:(a.seed??0)-(u.seed??0)});t(s.map((a,u)=>({...a,seed:u+1})))}return{moveUp:b,moveDown:i,shufflePlayers:y,sortPlayersByElo:k}}const be=({index:o,total:t,onMoveUp:b,onMoveDown:i})=>e.jsxs(e.Fragment,{children:[e.jsx(B,{type:"button",variant:"ghost",size:"sm",onClick:()=>{b(o)},disabled:o===0,className:"h-auto px-1.5 py-0.5 text-[var(--color-faint)] hover:text-[var(--color-text)] hover:bg-[var(--color-soft)]",children:e.jsx(ge,{className:"h-3.5 w-3.5"})}),e.jsx(B,{type:"button",variant:"ghost",size:"sm",onClick:()=>{i(o)},disabled:o===t-1,className:"h-auto px-1.5 py-0.5 text-[var(--color-faint)] hover:text-[var(--color-text)] hover:bg-[var(--color-soft)]",children:e.jsx(ve,{className:"h-3.5 w-3.5"})})]}),ye=({useElo:o,onSortByElo:t,onShuffle:b})=>{const{t:i}=V();return e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(B,{type:"button",variant:"link",onClick:t,disabled:!o,className:"text-sm px-0 h-auto",children:i("players.sortByElo")}),e.jsx(B,{type:"button",variant:"link",onClick:b,className:"text-sm px-0 h-auto",children:i("players.shuffle")})]})};function Ne(o,t){return o?"opacity-40 border-[var(--color-border)]":t?"border-[var(--color-primary)] bg-[var(--color-soft)]":"border-[var(--color-border)] hover:border-[var(--color-border-strong)] hover:bg-[var(--color-soft)]"}const je=({players:o,setPlayers:t,register:b,errors:i,setValue:y,useElo:k,onAddPlayer:s})=>{const{t:a}=V(),{moveUp:u,moveDown:p,shufflePlayers:h,sortPlayersByElo:f}=fe(o,t),[c,j]=I.useState(null),[S,L]=I.useState(null);function M(l){j(l)}function T(l,n){l.preventDefault(),S!==n&&L(n)}function P(l){if(c===null||c===l){j(null),L(null);return}const n=[...o],[m]=n.splice(c,1);if(m===void 0){j(null),L(null);return}n.splice(l,0,m),t(n.map((x,E)=>({...x,seed:E+1}))),j(null),L(null)}function R(){j(null),L(null)}function U(l){const n=o.filter(m=>m.id!==l).map((m,x)=>({...m,seed:x+1}));t(n)}return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(K,{children:a("players.title",{count:o.length})}),o.length>1&&e.jsx(ye,{useElo:k,onSortByElo:f,onShuffle:h})]}),e.jsxs("div",{className:"mb-3 space-y-2",children:[e.jsxs("div",{className:"grid grid-cols-[1fr_auto] gap-2 sm:flex sm:gap-2",children:[e.jsx(_,{id:"player-name",type:"text","aria-label":a("players.placeholder"),onKeyDown:l=>{l.key==="Enter"&&(l.preventDefault(),s())},placeholder:a("players.placeholder"),className:"min-w-0 sm:flex-1",...b("playerName",{validate:l=>{const n=l.trim();return n?!o.some(m=>m.name.toLowerCase()===n.toLowerCase())||a("players.errorUnique"):!0}})}),e.jsx(B,{type:"button",onClick:()=>{s()},children:a("players.add")})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ue,{id:"use-elo",checked:k,onCheckedChange:l=>{y("useElo",l===!0)}}),e.jsx(G,{htmlFor:"use-elo",className:"text-sm text-[var(--color-text)]",children:a("players.useElo")}),e.jsx(_,{id:"elo-rating",type:"number",min:"0","aria-label":a("players.eloPlaceholder"),onKeyDown:l=>{l.key==="Enter"&&(l.preventDefault(),s())},placeholder:a("players.eloPlaceholder"),disabled:!k,className:"w-24",...b("playerElo",{valueAsNumber:!0})})]})]}),i.playerName&&e.jsx("p",{className:"text-[var(--color-accent)] text-sm mb-2",children:i.playerName.message}),e.jsx("ul",{className:"space-y-1",children:o.map((l,n)=>e.jsxs("li",{draggable:!0,onDragStart:()=>{M(n)},onDragOver:m=>{T(m,n)},onDrop:()=>{P(n)},onDragEnd:R,className:`flex items-center gap-2 border rounded-lg px-3 py-2 transition-colors ${Ne(c===n,S===n)}`,children:[e.jsx(re,{className:"h-4 w-4 text-[var(--color-faint)] cursor-grab shrink-0"}),e.jsxs("span",{className:"text-[var(--color-faint)] text-sm w-6 text-right",children:["#",l.seed]}),e.jsx("span",{className:"flex-1 text-sm",children:l.name}),l.elo!=null&&e.jsx("span",{className:"text-xs text-[var(--color-faint)]",children:a("players.elo",{elo:l.elo})}),e.jsx(be,{index:n,total:o.length,onMoveUp:u,onMoveDown:p}),e.jsx(B,{type:"button",variant:"ghost",size:"sm",onClick:()=>{U(l.id)},className:"h-auto px-1.5 py-0.5 text-[var(--color-accent)] hover:text-[var(--color-primary-dark)] hover:bg-[var(--color-accent-soft)]",children:e.jsx(he,{className:"h-3.5 w-3.5"})})]},l.id))})]})};function Se(o,t,b,i,y){return t===b?o.filter(k=>k!==y):t===i?[...o,y]:o}const Ee=({format:o,players:t,groupCount:b,externalGroups:i,onGroupsChange:y})=>{const{t:k}=V(),s=I.useMemo(()=>o===d.SINGLE_ELIM?J(t):null,[o,t]),a=I.useMemo(()=>o===d.DOUBLE_ELIM?Z(t):null,[o,t]),u=I.useMemo(()=>o===d.GROUPS_TO_BRACKET?ee(t,b):null,[o,t,b]),[p,h]=I.useState(null),[f,c]=I.useState(u),[j,S]=I.useState(null),[L,M]=I.useState(null);f!==u&&(c(u),h(i??u),S(null),M(null));function T(m,x){S({playerId:m,fromGroupIndex:x})}function P(m,x){m.preventDefault(),L!==x&&M(x)}function R(m){m.currentTarget.contains(m.relatedTarget)||M(null)}function U(m){if(!j||!p){S(null),M(null);return}const{playerId:x,fromGroupIndex:E}=j;if(E!==m){const D=p.map((C,A)=>({...C,playerIds:Se(C.playerIds,A,E,m,x)}));h(D),y?.(D)}S(null),M(null)}function l(){S(null),M(null)}const n=p??u;return!s&&!a&&!n?null:e.jsxs("div",{children:[s&&e.jsx("div",{className:"border border-[var(--color-border)] rounded-xl p-4",children:e.jsx(H,{bracket:s,players:t})}),a&&e.jsx("div",{className:"border border-[var(--color-border)] rounded-xl p-4",children:e.jsx(H,{bracket:a.winners,players:t})}),n&&e.jsx("div",{className:"space-y-3",children:n.map((m,x)=>e.jsxs("div",{onDragOver:E=>{P(E,x)},onDragLeave:R,onDrop:()=>{U(x)},className:`border rounded-xl p-4 transition-colors ${L===x&&j?.fromGroupIndex!==x?"border-[var(--color-primary)] bg-[var(--color-soft)]":"border-[var(--color-border)]"}`,children:[e.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)] mb-3",children:k("groupStage.groupTitle",{label:Q(x)})}),e.jsx("ul",{className:"space-y-1 min-h-[2rem]",children:m.playerIds.map((E,D)=>{const C=t.find(r=>r.id===E),A=j?.playerId===E;return e.jsxs("li",{draggable:!0,onDragStart:()=>{T(E,x)},onDragEnd:l,className:`flex items-center gap-2 border border-[var(--color-border)] rounded-lg px-3 py-2 text-sm transition-colors ${A?"opacity-40":""}`,children:[e.jsx(re,{className:"h-4 w-4 text-[var(--color-faint)] cursor-grab shrink-0"}),e.jsxs("span",{className:"text-[var(--color-faint)] w-5 text-right",children:["#",D+1]}),e.jsx("span",{className:"flex-1",children:C?.name??E}),C?.elo!=null&&e.jsx("span",{className:"text-xs text-[var(--color-faint)]",children:k("players.elo",{elo:C.elo})})]},E)})})]},m.id))})]})},Oe=()=>{const o=ae(),{t}=V(),{tracker:b}=ne();ce(t("create.title"));const{register:i,control:y,handleSubmit:k,setValue:s,setError:a,trigger:u,getValues:p,resetField:h,formState:{errors:f}}=oe({defaultValues:{name:"",format:d.SINGLE_ELIM,scoringMode:W.SETS,maxSets:$,groupStageMaxSets:$,bracketMaxSets:$,groupCount:2,consolation:!1,bracketType:q.SINGLE_ELIM,qualifiers:[{value:2},{value:2}],playerName:"",playerElo:1e3,useElo:!1}}),[c,j]=I.useState([]),{fields:S,append:L,remove:M}=se({control:y,name:"qualifiers"}),T=F({control:y,name:"format"}),P=F({control:y,name:"scoringMode"}),R=F({control:y,name:"bracketType"}),U=F({control:y,name:"useElo"}),l=F({control:y,name:"groupCount"}),[n,m]=I.useState(null),x=n!==null&&n.players===c&&n.format===T&&n.groupCount===l?n.groups:null;async function E(){if(!await u("playerName"))return;const v=p("playerName").trim();if(!v)return;const N=p("playerElo"),g=p("useElo");j([...c,{id:crypto.randomUUID(),name:v,seed:c.length+1,elo:g&&Number.isFinite(N)?N:void 0}]),h("playerName"),h("playerElo")}function D(r){const v=Number.parseInt(r,10);return Number.isFinite(v)?Math.max(1,v):$}function C(r){const v=Math.max(1,Number.parseInt(r,10)||1);if(s("groupCount",v),v>S.length){const N=v-S.length;for(let g=0;g<N;g++)L({value:2})}else if(v<S.length){const N=Array.from({length:S.length-v},(g,w)=>v+w);M(N)}}const A=k(r=>{if(c.length<Y){a("root",{message:t("create.errorPlayers",{minPlayers:Y})});return}if(r.format===d.GROUPS_TO_BRACKET&&r.groupCount>c.length){a("root",{message:t("create.errorGroupsTooMany")});return}const v=r.qualifiers.map(O=>O.value);if(r.format===d.GROUPS_TO_BRACKET){const O=x??ee(c,r.groupCount);for(const[X,te]of O.entries()){const z=v[X]??0;if(z>0&&te.playerIds.length<z){a("root",{message:t("create.errorGroupTooFewPlayers",{label:Q(X),count:z})});return}}}const N={id:crypto.randomUUID(),name:r.name.trim(),scoringMode:r.scoringMode,maxSets:r.maxSets,groupStageMaxSets:r.groupStageMaxSets,bracketMaxSets:r.bracketMaxSets,players:c.map(O=>({...O})),createdAt:new Date().toISOString(),completedAt:null,winnerId:null};let g;switch(r.format){case d.SINGLE_ELIM:{g={...N,format:d.SINGLE_ELIM,bracket:J(c)};break}case d.ROUND_ROBIN:{g={...N,format:d.ROUND_ROBIN,schedule:pe(c)};break}case d.DOUBLE_ELIM:{g={...N,format:d.DOUBLE_ELIM,doubleElim:Z(c)};break}case d.GROUPS_TO_BRACKET:{const O=xe(c,{groupCount:r.groupCount,qualifiers:v,consolation:r.consolation,bracketType:r.bracketType},x??void 0);g={...N,format:d.GROUPS_TO_BRACKET,groupStage:O,groupStagePlayoffs:null};break}case d.SWISS:{g={...N,format:d.SWISS,schedule:de(c),totalRounds:me(c.length)};break}}const w={[d.SINGLE_ELIM]:q.SINGLE_ELIM,[d.DOUBLE_ELIM]:q.DOUBLE_ELIM,[d.GROUPS_TO_BRACKET]:r.bracketType,[d.ROUND_ROBIN]:"none",[d.SWISS]:"none"};b.trackTournamentCreated({tournament_type:r.format,scoring_mode:r.scoringMode,player_count:c.length,playoff_type:w[r.format]??"none"}),ie.save(g),o(`/tournament/${g.id}`)});return e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-[var(--color-text)] mb-6",children:t("create.title")}),e.jsxs("form",{onSubmit:r=>{A(r)},className:"space-y-7",children:[e.jsxs("div",{className:"grid grid-cols-1 gap-7 lg:grid-cols-2 lg:gap-8 lg:items-start",children:[e.jsxs("div",{className:"space-y-7",children:[e.jsxs("div",{children:[e.jsx(G,{htmlFor:"tournament-name",className:"block text-sm font-medium text-[var(--color-text)] mb-1",children:t("create.nameLabel")}),e.jsx(_,{id:"tournament-name",type:"text",placeholder:t("create.namePlaceholder"),...i("name",{required:t("create.errorName")})}),f.name&&e.jsx("p",{className:"text-[var(--color-accent)] text-sm mt-1",children:f.name.message})]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.formatLabel")}),e.jsx("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:Object.values(d).map(r=>e.jsxs("label",{className:`flex items-center justify-center flex-1 text-center px-4 py-2 rounded-lg border text-sm cursor-pointer transition-colors ${T===r?"bg-[var(--color-primary)] text-[var(--color-surface)] border-[var(--color-primary)] shadow-sm":"text-[var(--color-muted)] border-[var(--color-border)] hover:border-[var(--color-primary)]"}`,children:[e.jsx("input",{type:"radio",value:r,className:"sr-only",...i("format")}),t(`format.${r}`)]},r))})]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.scoringLabel")}),e.jsx("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:Object.values(W).map(r=>e.jsxs("label",{className:`flex-1 text-center px-4 py-2 rounded-lg border text-sm cursor-pointer transition-colors ${P===r?"bg-[var(--color-primary)] text-[var(--color-surface)] border-[var(--color-primary)] shadow-sm":"text-[var(--color-muted)] border-[var(--color-border)] hover:border-[var(--color-primary)]"}`,children:[e.jsx("input",{type:"radio",value:r,className:"sr-only",...i("scoringMode")}),t(r===W.SETS?"create.scoringSets":"create.scoringPoints")]},r))})]}),T!==d.GROUPS_TO_BRACKET&&e.jsxs("div",{children:[e.jsx(G,{htmlFor:"max-sets",className:"block text-sm font-medium text-[var(--color-text)] mb-1",children:t("create.maxSetsLabel")}),e.jsx(_,{id:"max-sets",type:"number",min:"1",className:"w-24",...i("maxSets",{valueAsNumber:!0,onChange:r=>{s("maxSets",D(r.target.value))}})})]}),T===d.GROUPS_TO_BRACKET&&e.jsxs("div",{className:"space-y-4 border border-[var(--color-border)] rounded-xl p-5 bg-[var(--color-soft)]",children:[e.jsx("div",{className:"text-sm font-semibold text-[var(--color-muted)]",children:t("create.groupStageTitle")}),e.jsxs("div",{className:"flex flex-wrap gap-4",children:[e.jsxs(G,{className:"text-xs text-[var(--color-muted)]",children:[t("create.maxSetsGroupLabel"),e.jsx(_,{id:"group-stage-max-sets",type:"number",min:"1",className:"mt-1 w-24 h-8 px-2 py-1",...i("groupStageMaxSets",{valueAsNumber:!0,onChange:r=>{s("groupStageMaxSets",D(r.target.value))}})})]}),e.jsxs(G,{className:"text-xs text-[var(--color-muted)]",children:[t("create.maxSetsBracketLabel"),e.jsx(_,{id:"bracket-max-sets",type:"number",min:"1",className:"mt-1 w-24 h-8 px-2 py-1",...i("bracketMaxSets",{valueAsNumber:!0,onChange:r=>{s("bracketMaxSets",D(r.target.value))}})})]})]}),e.jsxs("div",{children:[e.jsx(G,{htmlFor:"group-count",className:"block text-sm font-medium text-[var(--color-text)] mb-1",children:t("create.groupCountLabel")}),e.jsx(_,{id:"group-count",type:"number",min:"1",className:"w-24",...i("groupCount",{valueAsNumber:!0,onChange:r=>{C(r.target.value)}})})]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.qualifiersLabel")}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:S.map((r,v)=>e.jsxs(G,{className:"text-xs text-[var(--color-muted)]",children:[t("create.groupLabel",{label:Q(v)}),e.jsx(_,{type:"number",min:"0",className:"mt-1 w-full h-8 px-2 py-1",...i(`qualifiers.${v}.value`,{valueAsNumber:!0})})]},r.id))})]}),e.jsxs(G,{className:"flex items-center gap-2 text-sm text-[var(--color-text)]",children:[e.jsx("input",{id:"consolation",type:"checkbox",...i("consolation")}),t("create.consolationLabel")]}),e.jsxs("div",{children:[e.jsx(K,{children:t("create.bracketTypeLabel")}),e.jsx("div",{className:"grid grid-cols-1 gap-2 md:grid-cols-2",children:Object.values(q).map(r=>e.jsxs("label",{className:`flex-1 text-center px-4 py-2 rounded-lg border text-sm cursor-pointer transition-colors ${R===r?"bg-[var(--color-primary)] text-[var(--color-surface)] border-[var(--color-primary)] shadow-sm":"text-[var(--color-muted)] border-[var(--color-border)] hover:border-[var(--color-primary)]"}`,children:[e.jsx("input",{type:"radio",value:r,className:"sr-only",...i("bracketType")}),t(r===q.SINGLE_ELIM?"create.bracketTypeSingle":"create.bracketTypeDouble")]},r))})]})]})]}),e.jsx("div",{children:e.jsx(je,{players:c,setPlayers:j,register:i,errors:f,setValue:s,useElo:U,onAddPlayer:()=>{E()}})})]}),e.jsx(Ee,{format:T,players:c,groupCount:l,externalGroups:x,onGroupsChange:r=>{const N=r.flatMap(g=>g.playerIds).map(g=>c.find(w=>w.id===g)).filter(g=>g!==void 0).map((g,w)=>({...g,seed:w+1}));j(N),m({groups:r,players:N,format:T,groupCount:l})}}),f.root&&e.jsx("p",{className:"text-[var(--color-accent)] text-sm",children:f.root.message}),e.jsx(B,{type:"submit",className:"w-full bg-[var(--color-primary)] text-[var(--color-surface)] py-3 rounded-lg font-medium shadow-sm hover:shadow-md hover:bg-[var(--color-primary-dark)] active:scale-[0.99]",children:t("create.submit")})]})]})};export{Oe as CreateTournamentPage};

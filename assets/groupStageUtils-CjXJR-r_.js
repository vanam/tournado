import{g as A,r as w,s as y,d as b,f as B,i as v,h as P,t as j,b as z,e as C,l as E,u as H,j as K}from"./BracketRounds-DE0E6v_t.js";import{a as k,S as Y}from"./ConfirmModal-Vvv4-snp.js";const _=j();function D(n){return _.nextId(n)}function J(n,e){const r=new Map;for(const t of n.rounds)for(const s of t){const o=`${e}${s.id}`;r.set(s.id,o),s.id=o}for(const t of n.rounds)for(const s of t)s.nextMatchId&&(s.nextMatchId=r.get(s.nextMatchId)??s.nextMatchId)}function g(n,e){for(const r of n){const t=r.find(s=>s.id===e&&!y(s));if(t)return t}return null}function W(n,e){const r=g(n.winners.rounds,e);if(r)return{section:"winners",match:r};const t=g(n.losers.rounds,e);return t?{section:"losers",match:t}:n.finals.grandFinal.id===e?{section:"finals",match:n.finals.grandFinal}:n.finals.resetFinal.id===e?{section:"finals",match:n.finals.resetFinal}:null}function X(n){return n.rounds.at(-1)?.[0]??null}function q(n){return n?.winnerId&&n.player1Id&&n.player2Id?n.winnerId===n.player1Id?n.player2Id:n.player1Id:null}function S(n){return!n||y(n)?!1:n.winnerId?!0:!n.player1Id&&!n.player2Id}function Q(n){return!n||y(n)?!1:!!n.winnerId||n.walkover||n.scores.length>0}function Z(n){const e=[],r={},t=n[0];if(!t)return{firstRound:e,loserLinks:r};for(let s=0;s<t.length;s+=2){const o=t[s],i=t[s+1];if(!o||!i)continue;const a={...w(D("l-"),{position:s/2}),winnersSources:[o.id,i.id]};e.push(a),r[o.id]={matchId:a.id,slot:"player1Id"},r[i.id]={matchId:a.id,slot:"player2Id"},e.push({id:"",player1Id:null,player2Id:null,winnersSources:[],scores:[],winnerId:null,walkover:!1,position:e.length,dummy:!0})}return{firstRound:e,loserLinks:r}}function nn(n,e,r){const t=[];for(let s=e;s<=n.length;s+=1){const o=s-1,i=n[o];if(!i)continue;const a=i.length,l=[];for(let c=0;c<a;c+=1){const p=(c%2===0?"player1Id":"player2Id")==="player1Id"?"player2Id":"player1Id",h=i[c];if(!h)continue;const f={...w(D("l-"),{position:c}),winnersSources:[h.id],loserSlotFromWinners:p};l.push(f),r[h.id]={matchId:f.id,slot:p}}if(t.push(l),s<n.length){const c=[];for(let u=0;u<l.length;u+=2)c.push({...w(D("l-"),{position:u/2})});t.push(c)}}return t}function en(n){for(let e=0;e<n.length-1;e+=1){const r=n[e+1];if(!Array.isArray(r)||r.length===0)continue;const t=n[e];if(!Array.isArray(t)||t.length===0)continue;const s=(e+1)%2===1,o=t.filter(a=>!y(a)),i=r.filter(a=>!y(a));for(const[a,l]of o.entries()){const c=s?a:Math.floor(a/2);l.nextMatchId=i[c]?.id??null}}}function tn(n){const e=[],r=n.rounds;if(r.length<=1)return{rounds:e,loserLinks:{}};const{firstRound:t,loserLinks:s}=Z(r);t.length>0&&e.push(t);const o=nn(r,2,s);for(const i of o)e.push(i);return en(e),{rounds:e,loserLinks:s}}function I(n){n&&(n.winnerId=null,n.scores=[],n.walkover=!1)}function rn(n,e,r){if(y(n)||n.winnerId||!n.winnersSources||n.winnersSources.length===0||n.player1Id&&n.player2Id||!n.player1Id&&!n.player2Id||!n.winnersSources.every(s=>{const o=g(r,s);return S(o)}))return!1;if(e){const s=e.find(o=>o.nextMatchId===n.id&&!y(o));if(s&&!S(s))return!1}return!0}function sn(n,e){for(let r=1;r<e.rounds.length;r++){const t=e.rounds[r];if(t)for(const s of t){if(y(s)||!rn(s,e.rounds[r-1],n.rounds))continue;const o=s.player1Id??s.player2Id;o&&P(e,s.id,o,[])}}}function on(n){const{winners:e,losers:r,loserLinks:t}=n;ln(e,r,t),cn(e,r),sn(e,r)}function an(n){const{winners:e,losers:r,finals:t}=n,s=b(e),o=X(e),i=r.rounds.length>0?b(r):q(o),a=t.grandFinal,l=t.resetFinal,c=s??null,u=i??null;(c!==a.player1Id||u!==a.player2Id)&&(I(a),I(l),a.player1Id=c,a.player2Id=u),!!a.winnerId&&!!s&&a.winnerId!==s?(l.player1Id!==a.player1Id||l.player2Id!==a.player2Id)&&(I(l),l.player1Id=a.player1Id,l.player2Id=a.player2Id):(l.player1Id||l.player2Id||Q(l))&&(I(l),l.player1Id=null,l.player2Id=null)}function G(n){return on(n),an(n),n}function N(n){_.reset();const e=A(n);J(e,"w-");const{rounds:r,loserLinks:t}=tn(e),s={rounds:r},o={grandFinal:w(D("f-"),{position:0}),resetFinal:w(D("f-"),{position:1})},i={winners:e,losers:s,finals:o,loserLinks:t};return G(i),i}function Ln(n,e,r,t,s=!1){const o=W(n,e);return o&&(o.section==="winners"?P(n.winners,e,r,t,s):o.section==="losers"?P(n.losers,e,r,t,s):(e===n.finals.grandFinal.id&&(I(n.finals.resetFinal),n.finals.resetFinal.player1Id=null,n.finals.resetFinal.player2Id=null),o.match.winnerId=r,o.match.scores=t,o.match.walkover=s),G(n)),n}function Sn(n,e){const r=W(n,e);return r&&(r.section==="winners"?v(n.winners,e):r.section==="losers"?v(n.losers,e):(I(r.match),n.finals.grandFinal.id===e&&(I(n.finals.resetFinal),n.finals.resetFinal.player1Id=null,n.finals.resetFinal.player2Id=null)),G(n)),n}function Fn(n){const e=n.finals.resetFinal,r=n.finals.grandFinal,t=b(n.winners);return e.winnerId?e.winnerId:r.winnerId&&t&&r.winnerId===t?r.winnerId:null}function xn(n,e){const r=n.finals.resetFinal.winnerId??n.finals.grandFinal.winnerId,t=W(n,e);return t?t.section==="finals"?!0:r?!1:t.section==="losers"?B(n.losers,e):B(n.winners,e):!1}function ln(n,e,r){for(const[t,s]of Object.entries(r)){const o=g(n.rounds,t),i=g(e.rounds,s.matchId);if(!o||!i||y(i))continue;const a=q(o),l=s.slot==="player1Id"?i.player1Id:i.player2Id;a!==l&&(Q(i)&&v(e,i.id),s.slot==="player1Id"?i.player1Id=a??null:i.player2Id=a??null)}}function cn(n,e){const r=e.rounds[0]??[];for(const t of r){if(y(t)||t.winnersSources?.length!==2)continue;const s=t.winnersSources[0],o=t.winnersSources[1];if(!s||!o)continue;const i=g(n.rounds,s),a=g(n.rounds,o);!S(i)||!S(a)||(!t.winnerId&&t.player1Id&&!t.player2Id?P(e,t.id,t.player1Id,[]):!t.winnerId&&!t.player1Id&&t.player2Id&&P(e,t.id,t.player2Id,[]))}}const x="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function fn(n){let e=Math.max(0,n),r="";do r=(x[e%x.length]??"A")+r,e=Math.floor(e/x.length)-1;while(e>=0);return r}function L(n){return Number.isFinite(n)?n:1e3}function U(n,e){return Array.from({length:e},(r,t)=>{const s=n?.[t];return Math.max(0,Number(s)||0)})}function T(n){const e=Number(n);return Number.isFinite(e)?e:Number.POSITIVE_INFINITY}function un(n,e){const r=n.map((s,o)=>({player:s,index:o})).toSorted((s,o)=>{const i=T(s.player.seed),a=T(o.player.seed);return i!==a?i-a:s.index-o.index}).map(({player:s})=>s),t=Array.from({length:e},(s,o)=>({id:`g${o+1}`,name:`Group ${fn(o)}`,playerIds:[]}));for(const[s,o]of r.entries()){const i=t[s%e];i&&i.playerIds.push(o.id)}return t}function An(n,e,r){const t=Math.max(1,Number.parseInt(e.groupCount,10)||1),s=U(e.qualifiers,r?.length??t);return{groups:(r??un(n,t)).map((a,l)=>{const c=n.filter(p=>a.playerIds.includes(p.id)),u=z(c,{idPrefix:`${a.id}-`});return{...a,schedule:u,order:l+1}}),settings:{groupCount:t,qualifiers:s,consolation:!!e.consolation,bracketType:e.bracketType??k.SINGLE_ELIM}}}function $(n,e){return e.filter(r=>n.playerIds.includes(r.id))}function bn(n,e,r={}){return n.groups.map(t=>{const s=$(t,e),o=C(t.schedule,s,r);return{groupId:t.id,standings:o}})}function vn(n){return n.groups.every(e=>E(e.schedule))}function dn(n){const e=n.played||0,r=e>0?e:1,t=n.pointsWon-n.pointsLost;return{pointsPct:n.points/r,setDiffPerMatch:(n.setsWon-n.setsLost)/r,setsWonPerMatch:n.setsWon/r,pointsDiffPerMatch:t/r,played:e}}function pn(n=""){let e=5381;for(let r=0;r<n.length;r+=1)e=e*33^(n.codePointAt(r)??0);return e>>>0}function yn(n){const e=`${n.id}|${n.groupId}`;return pn(e)/4294967295}function hn(n,e){const r=n.tiebreakDetails,t=e.tiebreakDetails;return t.setsWonPerMatch!==r.setsWonPerMatch?t.setsWonPerMatch-r.setsWonPerMatch:t.setDiffPerMatch!==r.setDiffPerMatch?t.setDiffPerMatch-r.setDiffPerMatch:r.pointsDiffApplicable&&t.pointsDiffApplicable&&t.pointsDiffPerMatch!==r.pointsDiffPerMatch?t.pointsDiffPerMatch-r.pointsDiffPerMatch:r.opponentAvgRank!==t.opponentAvgRank?r.opponentAvgRank-t.opponentAvgRank:r.relativeRank!==t.relativeRank?r.relativeRank-t.relativeRank:r.fairPlay!==t.fairPlay?r.fairPlay?-1:1:0}function O(n){const e=n.tiebreakDetails;return[e.setsWonPerMatch,e.setDiffPerMatch,e.pointsDiffApplicable?e.pointsDiffPerMatch:null,e.opponentAvgRank,e.relativeRank,e.fairPlay].map(t=>Number.isFinite(t)?t.toFixed(6):typeof t=="boolean"?String(t):"n/a").join("|")}function In(n,e){if(!e)return[];const r=n.tiebreakDetails,t=e.tiebreakDetails,s=["setsWonPerMatch","setDiffPerMatch","pointsDiffPerMatch","opponentAvgRank","relativeRank","fairPlay"],o=[];for(const i of s){if(i==="pointsDiffPerMatch"&&!r.pointsDiffApplicable)continue;const a=r[i],l=t[i];let c=0;if(i==="opponentAvgRank"||i==="relativeRank")c=a-l;else if(i==="fairPlay"){const u=r.fairPlay?1:0;c=(t.fairPlay?1:0)-u}else c=l-a;if(c===0){o.push(i);continue}return o.push(i),o}return r.lotteryUsed&&o.push("lottery"),o}function gn(n){const e=new Map,r=new Map;for(const t of n.rounds)for(const s of t.matches){if(!s.winnerId)continue;const o=s.player1Id,i=s.player2Id;!o||!i||(e.has(o)||e.set(o,new Set),e.has(i)||e.set(i,new Set),e.get(o)?.add(i),e.get(i)?.add(o),(s.walkover||K(s.scores))&&(r.set(o,!0),r.set(i,!0)))}return{opponentsByPlayer:e,walkoverByPlayer:r}}function Mn(n,e,r,t,s){const o=$(n,e),i=C(n.schedule,o,s),a=i.length||1,l=new Map(i.map((f,d)=>[f.playerId,d+1])),{opponentsByPlayer:c,walkoverByPlayer:u}=gn(n.schedule),p=[],h=[];for(const[f,d]of i.entries()){const R=e.find(V=>V.id===d.playerId);if(!R)continue;const M=dn(d),F={setsWonPerMatch:M.setsWonPerMatch,setDiffPerMatch:M.setDiffPerMatch,pointsDiffPerMatch:M.pointsDiffPerMatch,opponentAvgRank:Pn(d.playerId,c,l,a),relativeRank:(f+1)/a,fairPlay:!u.get(d.playerId),pointsDiffApplicable:t,lottery:null,lotteryUsed:!1},m={...R,groupId:n.id,groupRank:f+1,stats:d,normalized:M,tiebreakDetails:F};f<r?p.push({...m,advanceType:"qualifier"}):h.push({...m,advanceType:"nonQualifier"})}return{main:p,nonQualifiers:h}}function kn(n,e){let r=0;for(;r<n.length;){let t=r+1;const s=n[r];if(!s)break;const o=O(s);for(;t<n.length;){const i=n[t];if(!i||O(i)!==o)break;t+=1}if(t-r>1){const i=n.slice(r,t).map(a=>(a.tiebreakDetails.lottery=yn(a),a.tiebreakDetails.lotteryUsed=!0,a));i.toSorted((a,l)=>(a.tiebreakDetails.lottery??0)-(l.tiebreakDetails.lottery??0));for(const[a,l]of i.entries())n[r+a]=l}r=t}for(const[t,s]of n.entries()){if(e<=0||n.length<2){s.tiebreakApplied=[];continue}const o=e-1,i=t<=o?o+1:o,a=n[i]??null;s.tiebreakApplied=In(s,a)}}function wn(n,e,r={}){const t=U(n.settings.qualifiers,n.groups.length);let s=[];const o=[],i=r.scoringMode===Y.POINTS;for(const[f,d]of n.groups.entries()){const R=Math.min(t[f]??0,d.playerIds.length),{main:M,nonQualifiers:F}=Mn(d,e,R,i,r);s.push(...M),o.push(...F)}s=s.toSorted((f,d)=>f.groupRank!==d.groupRank?f.groupRank-d.groupRank:L(d.elo)-L(f.elo));const a=H(s.length||1),l=Math.max(0,a-s.length),c=[...o].toSorted(hn);kn(c,l);const u=c.slice(0,l).map(f=>({...f,advanceType:"lucky"})),p=new Set(u.map(f=>f.id)),h=o.filter(f=>!p.has(f.id)).toSorted((f,d)=>L(d.elo)-L(f.elo));return{main:s,luckyLosers:u,mainWithLucky:[...s,...u],consolation:h,luckyCandidates:c,bracketTargetSize:a,luckyLoserSlots:l}}function Wn(n,e,r={}){const{mainWithLucky:t,consolation:s}=wn(n,e,r),o=n.settings.bracketType??k.SINGLE_ELIM,i=o===k.SINGLE_ELIM&&t.length>=2?A(t):null,a=o===k.DOUBLE_ELIM&&t.length>=2?N(t):null,l=o===k.SINGLE_ELIM&&n.settings.consolation&&s.length>=2?A(s):null,c=o===k.DOUBLE_ELIM&&n.settings.consolation&&s.length>=2?N(s):null;return{bracketType:o,mainBracket:i,mainDoubleElim:a,consolationBracket:l,consolationDoubleElim:c}}function Pn(n,e,r,t){const s=e.get(n);if(!s||s.size===0)return t;let o=0,i=0;for(const a of s){const l=r.get(a)??t;o+=l,i+=1}return i>0?o/i:t}export{Fn as a,xn as b,An as c,un as d,Ln as e,Sn as f,N as g,$ as h,fn as i,bn as j,vn as k,wn as l,Wn as m};
